---
title: "ä¿å§†çº§ Jest æ•™ç¨‹"
date: 2023-04-17T17:25:48+08:00
---

### jest è¦†ç›–ç‡

> æœ¬æ–‡ä¸é€‚åˆçº¯ç™½ç”¨æˆ·ï¼Œå»ºè®®å…ˆé˜…è¯» jest çš„ Getting Startedï¼š[jestjs.io/docs/gettinâ€¦](https://jestjs.io/docs/getting-started%E3%80%82) å†æ¥é˜…è¯»æœ¬æ–‡ï¼Œä½“æ„Ÿæ›´å¥½ã€‚

é€šè¿‡ `jest --coverage` ä¹Ÿå« `collectCoverage`ï¼Œè¯¥æŒ‡ä»¤å¯ä»¥æ”¶é›†æµ‹è¯•è¦†ç›–ç‡ä¿¡æ¯å¹¶åœ¨è¾“å‡ºä¸­æŠ¥å‘Šã€‚ æˆªå›¾å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a7186f030d84b668a6d2e4b2f9621fb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

- `%stmts` æ˜¯è¯­å¥è¦†ç›–ç‡ï¼ˆstatement coverageï¼‰ï¼šæ˜¯ä¸æ˜¯æ¯ä¸ªè¯­å¥éƒ½æ‰§è¡Œäº†ï¼Ÿ
- `%Branch` åˆ†æ”¯è¦†ç›–ç‡ï¼ˆbranch coverageï¼‰ï¼šæ˜¯ä¸æ˜¯æ¯ä¸ª if ä»£ç å—éƒ½æ‰§è¡Œäº†ï¼Ÿ
- `%Funcs` å‡½æ•°è¦†ç›–ç‡ï¼ˆfunction coverageï¼‰ï¼šæ˜¯ä¸æ˜¯æ¯ä¸ªå‡½æ•°éƒ½è°ƒç”¨äº†ï¼Ÿ
- `%Lines` è¡Œè¦†ç›–ç‡ï¼ˆline coverageï¼‰ï¼šæ˜¯ä¸æ˜¯æ¯ä¸€è¡Œéƒ½æ‰§è¡Œäº†ï¼Ÿ
- `Uncovered Line` ï¼š æœªè¦†ç›–åˆ°çš„è¡Œæ•°

### å›è°ƒå‡½æ•°

#### å¼‚æ­¥åœºæ™¯

ä¾‹å¦‚ï¼š ä¸€ä¸ªçš„ä¸šåŠ¡åœºæ™¯ï¼šè¯·æ±‚å‡½æ•°ï¼Œè¯·æ±‚æˆåŠŸåå°†æ•°æ®æ”¾åˆ°`callback`ä¸­ï¼Œè¿›è¡Œæ•°æ®å¤„ç†ã€‚

demo å¦‚ä¸‹ï¼š

```js
function fetchData(cb) {
  setTimeout(() => {
    cb("hello world");
  }, 1000);
}
```

æµ‹è¯•ä»£ç 

```js
test("å¼‚æ­¥å¸¸æ™¯", (done) => {
  fetchData((params) => {
    try {
      expect(params).toBe("hello world"); // ok
      done();
    } catch (error) {
      done(error);
    }
  });
});
```

1. æ­¤æ—¶å¿…é¡»æ·»åŠ  `done` ä½œä¸ºå›è°ƒçš„ç»“æŸï¼Œå¦‚æœä¸æ·»åŠ  `done` å‡½æ•°ï¼Œåˆ™ä¼šæç¤ºè¶…æ—¶ã€‚
   å› ä¸º `fetchData` è°ƒç”¨ç»“æŸåï¼Œæ­¤æµ‹è¯•å°±æå‰ç»“æŸäº†ã€‚ å¹¶æœªç­‰ `callback` çš„è°ƒç”¨ã€‚

   ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbbcb880951441e6b3aab47b9c37d2ab~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

2. å¦‚æœåœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°ä¸ç¬¦åˆé¢„æœŸçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨`try catch`å°†é”™è¯¯çš„ä¿¡æ¯ä¼ é€’ç»™ done çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚
3. å¦‚æœä¸ä¼ é€’é”™è¯¯ä¿¡æ¯ã€‚é‡åˆ°é”™è¯¯ä¹Ÿå¯ä»¥é€šè¿‡æµ‹è¯•ï¼Œæ­¤æ—¶çš„æµ‹è¯•ç»“æœæ˜¯ä¸å‡†ç¡®çš„ã€‚

```js
// æ­¤æµ‹è¯•ç”¨ä¾‹ä¹Ÿå¯ä»¥é€šè¿‡
test("callback", (done) => {
  fetchData((params) => {
    try {
      throw Error("error");
      done();
    } catch (error) {
      done();
    }
  });
});
```

#### åŒæ­¥å›è°ƒ

```js
test("åŒæ­¥åœºæ™¯", () => {
  const fun = (cb) => {
    cb && cb();
  };
  const cbFun = jest.fn();
  fun(cbFun);
  expect(cbFun).toBeCalled(); // ok
});
```

### å¼‚æ­¥å‡½æ•°

å¼‚æ­¥ä»£ç å¦‚ä¸‹

```js
function fetchData(type) {
  return type ? Promise.resolve("success") : Promise.reject("error");
}
```

æµ‹è¯•é€»è¾‘

1. é€šè¿‡ `promise` çš„æ–¹å¼

> æ­¤å¤„å¿…é¡»`return` ï¼ŒæŠŠæ•´ä¸ªæ–­è¨€ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚å¦‚æœä½ å¿˜äº†`return`è¯­å¥çš„è¯ï¼Œåœ¨ Â `fetchData`Â  è¿”å›çš„è¿™ä¸ª `promise` å˜æ›´ä¸º `resolved` çŠ¶æ€ã€`then()` æœ‰æœºä¼šæ‰§è¡Œä¹‹å‰ï¼Œæµ‹è¯•å°±å·²ç»è¢«è§†ä¸ºå·²ç»å®Œæˆäº†

```js
test("promise rejected", () => {
  return expect(fetchData(false)).reject.toBe("error");
});

test("promise resolve", () => {
  return expect(fetchData(true)).resolve.toBe("success");
});
```

2. é€šè¿‡ `async / await` çš„æ–¹å¼

```js
test("async resolve", async () => {
  let res = await fetchData(true);
  expect(res).toBe("success");
});

test("async reject", async () => {
  try {
    await fetchData(false);
  } catch (error) {
    expect(error).toMatch("error");
  }
});
```

> æ³¨æ„ï¼š  
> `expect.assertions(1)` æ¨èæ·»åŠ ã€‚å¦‚æœ fetchData ä¸æ‰§è¡Œ rejectï¼Œæµ‹è¯•ç”¨ä¾‹ä¾æ—§å¯ä»¥é€šè¿‡ï¼Œä½†æ˜¯å¦‚æœæ·»åŠ  `expect.assertions(1)` ï¼Œåˆ™è¦æ±‚æ­¤æµ‹è¯•ç”¨ä¾‹è‡³å°‘è¦è¢«è¿è¡Œä¸€æ¬¡ã€‚å³ å¿…é¡» `mock` ä¸€æ¬¡ `promise.reject`çš„æƒ…å†µ

### try catch

demo ä»£ç 

```js
const tryCatch = (data) => {
  try {
    data.push(77);
  } catch (error) {
    console.error("tryCatch", error.message);
    return null;
  }
};
```

æµ‹è¯•é€»è¾‘

```js
it("should throw an error if an exception is thrown", () => {
  // ä½¿ç”¨ spyOn è¿›è¡Œæ¨¡æ‹Ÿ console æ–¹æ³•ï¼Œç›‘å¬ console.error æ–¹æ³•
  const spy = jest.spyOn(console, "error");
  const result = tryCatch(123);
  // æµ‹è¯•è¿”å›å€¼
  expect(result).toBeNull();
  // ä¼ é€’çš„å‚æ•°ç¬¬ä¸€ä¸ªæ˜¯ tryCatch
  expect(spy).toHaveBeenCalledWith("tryCatch", expect.stringContaining(""));
  // æ¢å¤åŸæ¥ console.error æ–¹æ³•ã€‚ï¼ˆé˜²æ­¢å½±å“åç»­æµç¨‹ï¼‰
  spy.mockRestore();
});
```

`jest.spyOn` æ–¹æ³•å¯ä»¥æ›¿æ¢æ¨¡å—ä¸­åŸæœ‰çš„æ–¹æ³•ã€‚ä¾‹

```js
jest.spyOn(console, "error").mockImplementation(() => "this is error");
console.error(); // this is error
```

### æ¨¡æ‹Ÿ-æ¨¡å—

#### æ¨¡æ‹Ÿ-æœ¬åœ°æ¨¡å—

**1\. æ–¹å¼ä¸€**  
å‡å¦‚æˆ‘ä»¬è¦æ¨¡æ‹Ÿä¸€ä¸ª `index.js` çš„æ¨¡å—ã€‚  
é¦–å…ˆåœ¨ `index.js` æ–‡ä»¶åŒçº§ç›®å½•æ–°å»ºä¸€ä¸ªåå­—ä¸º `__mocks__` çš„æ–‡ä»¶å¤¹ï¼Œå†åˆ›å»ºä¸€ä¸ªåå­—ä¸è¦æ¨¡æ‹Ÿæ¨¡å—ç›¸åŒçš„æ–‡ä»¶ã€‚  
ä¾‹å¦‚ï¼š

```bash
â”œâ”€â”€ __mocks__
â”‚   â””â”€â”€ index.js
â””â”€â”€ index.js
```

Demo ç¤ºä¾‹

```bash
â”œâ”€â”€ __test__
â”‚   â””â”€â”€ index.test.jsx
â”œâ”€â”€ index.jsx
â””â”€â”€ service
    â”œâ”€â”€ __mocks__
    â”‚   â””â”€â”€ index.js
    â””â”€â”€ index.js
```

```jsx
// index.jsx
import React from "react";
import localModule from "./service/index.js";

export const InputCom = () => {
  return <div>{localModule.name}</div>;
};
```

```js
// service/index.js
module.exports = {
  name: "localModule",
};
```

```js
// service/__mocks__/index.js
module.exports = {
  name: "mock localModule",
};
```

```jsx
// index.test.js
import { render, screen } from "@testing-library/react";
import { LocalTest } from "..";
import React from "react";
import "../service";
jest.mock("../service");

test("æµ‹è¯•æœ¬åœ°æ¨¡å—", () => {
  render(<LocalTest></LocalTest>);
  screen.debug();
});
```

æµ‹è¯•ç»“æœï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8095f0339a48401c97c5517a12dc4296~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

> æ³¨æ„ï¼šæœ‰ä¸¤ä¸ªæ³¨æ„äº‹é¡¹  
> 1ã€è¯¥`__mocks__`æ–‡ä»¶å¤¹åŒºåˆ†å¤§å°å†™ï¼Œå› æ­¤`__MOCKS__`åœ¨æŸäº›ç³»ç»Ÿä¸Šå‘½åè¯¥ç›®å½•ä¼šä¸­æ–­ã€‚ 2ã€æˆ‘ä»¬å¿…é¡»æ˜¾å¼è°ƒç”¨`jest.mock('./moduleName')`ã€‚

**2\. æ–¹å¼äºŒ**

é€šè¿‡ `jest.mock` æ–¹æ³•ï¼Œåœ¨æ–‡ä»¶å†…è¿›è¡Œæ•°æ®çš„æ¨¡æ‹Ÿã€‚ä¸åˆ›å»º `__mocks__` æ–‡ä»¶ã€‚

æˆ‘ä»¬æ”¹å†™æµ‹è¯•æ–‡ä»¶ã€‚

```jsx
// index.test.js
import { render, screen } from "@testing-library/react";
import { LocalTest } from "..";
import React from "react";
import "../service";
jest.mock("../service", () => ({
  name: "mock localModule",
}));

test("æµ‹è¯•æœ¬åœ°æ¨¡å—", () => {
  render(<LocalTest></LocalTest>);
  screen.debug();
});
```

æµ‹è¯•çš„ç»“æœä¸æ–¹å¼ä¸€ä¸€æ ·ã€‚

#### æ¨¡æ‹Ÿ-ç¬¬ä¸‰æ–¹æ¨¡å—

**1\. æ–¹å¼ä¸€**

- æˆ‘ä»¬åœ¨ä¸ node_modules åŒçº§ç›®å½•ä¸‹åˆ›å»º`__mocks__`
- åœ¨`__mocks__`ä¸‹é¢åˆ›å»ºæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿçš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œæ ¼å¼ï¼š@scoped/moduled-name.jsï¼Œä¾‹å¦‚ï¼š @testing/funã€‚ æˆ‘ä»¬åˆ›å»º `__mocks__/@testing/fun.js` æ–‡ä»¶ã€‚

```bash
â”œâ”€â”€ package.json
â”œâ”€â”€ node_modules
â”œâ”€â”€ index.js
â”œâ”€â”€ __mocks__
â”‚   â””â”€â”€ @testing
â”‚       â””â”€â”€ fun.js
â”œâ”€â”€ __test__
â”‚   â””â”€â”€ index.test.jsx
â”œâ”€â”€ index.jsx
```

```jsx
// index.jsx
import React from "react";
import nodeModule from "@testing/fun";

export const NodeModuleTest = () => {
  return <div>{nodeModule?.name}</div>;
};
```

```js
// @testing/fun
module.exports = {
  name: "module-name",
  age: "module-age",
  fun: () => "module-fun",
};
```

```js
// __mocks__/@testing/fun.js
module.exports = {
  name: "mock-nodeModule",
  fun: () => "mock-fun",
};
```

```js
//index.test.js
import { screen } from "@testing-library/react";
import "@testing-library/jest-dom";
import React from "react";
import NodeModuleTest from "..";
it("æµ‹è¯•ç¬¬ä¸‰æ–¹æ¨¡å—", () => {
  render(<NodeModuleTest />);
  screen.debug();
});
```

è¿è¡Œæµ‹è¯•ç”¨ä¾‹ä»¥åï¼Œç»“æœï¼š  
![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae5d0cce19e14db69391c3117cb76bde~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

> âš ï¸ æ³¨æ„ï¼š  
> 1ã€æ¨¡æ‹Ÿç¬¬ä¸‰æ–¹æ¨¡å—æ— é¡»æ˜¾ç¤ºè°ƒç”¨ `jest.mock`ã€‚  
> 2ã€`Node` å†…ç½®çš„æ¨¡å—ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾ç¤ºçš„è°ƒç”¨ `jest.mock` ä¾‹å¦‚ `fs` ,æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨çš„è°ƒç”¨`jest.mock(fs)`

**2\. æ–¹å¼äºŒ**

```js
//index.test.js
import { screen } from "@testing-library/react";
import "@testing-library/jest-dom";
import React from "react";
import NodeModuleTest from "..";
jest.mock("@testing/fun", () => ({
  name: "mock-module-jest.mock",
}));
it("æµ‹è¯•ç¬¬ä¸‰æ–¹æ¨¡å—", () => {
  render(<NodeModuleTest />);
  screen.debug();
});
```

è¿è¡Œæµ‹è¯•ç”¨ä¾‹ä»¥åçš„ç»“æœï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/161357af997246f9a6e4e91f838727c2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

> å³ä½¿æœ‰\_\_mocks\_\_/@scoped/project-name.js æ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ä¸­çš„å•ç‹¬å†™çš„ jest.mock æ–¹æ³•æƒé‡æœ€é«˜ã€‚

æˆ‘ä»¬æ¨¡æ‹Ÿçš„æ—¶å€™åï¼Œå¯èƒ½æœ‰ä»¥ä¸‹çš„è¯‰æ±‚ï¼š å‡è®¾ç¬¬ä¸‰æ–¹åŒ…å¯¼å‡ºäº† `aï¼Œbï¼Œc ä¸‰ä¸ªæ–¹æ³•`ã€‚

- `b æ–¹æ³•`ä½¿ç”¨çœŸå®æ–¹æ³•ï¼Œå…¶ä»–å¯¼å‡ºä½¿ç”¨æ¨¡æ‹Ÿçš„æ–¹æ³•ã€‚
- ä»…æ¨¡æ‹Ÿ `a æ–¹æ³•`ï¼Œå…¶ä»–å¯¼å‡ºä½¿ç”¨çœŸæ˜¯æ–¹æ³•ã€‚

ä»¥ä¸Šä¸¤ç§æƒ…å†µæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨ `jest.requireActual()` æ¥è§£å†³ã€‚

```jsx
// index.jsx
import React from "react";
import nodeModule from "@testing/fun";

export const NodeModuleTest = () => {
  return (
    <div>
      {nodeModule?.name}
      {nodeModule?.age}
      {nodeModule?.sex}
    </div>
  );
};
```

```js
// @testing/fun
module.exports = {
  name: "module-name",
  age: "module-age",
  sex: "module-sex",
};
```

```js
//index.test.js
import { screen } from "@testing-library/react";
import "@testing-library/jest-dom";
import React from "react";
import NodeModuleTest from '..'
jest.mock("@testing/fun", () => {
  const originalModule = jest.requireActual("@testing/fun");
  return {
    // __esModule: true, // å¤„ç† esModules æ¨¡å—
    ...originalModule,
    name: "mock-module-jest.mock",
  }
})
it("æµ‹è¯•ç¬¬ä¸‰æ–¹æ¨¡å—", () => { render(<NodeModuleTest />) screen.debug(); });
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f008b7f9286046c891558210bc91f034~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

### å‡½æ•°æµ‹è¯•

#### .mock å±æ€§

åœ¨å­¦ä¹ å‡½æ•°æµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£`.mock`å±æ€§éƒ½æœ‰å“ªäº›ï¼Ÿ  
æµ‹è¯• demo å¦‚ä¸‹ï¼š

```js
test(".mock", () => {
  const mockFun = jest.fn(() => {});
  console.log(mockFun.mock);
});
```

ç»“æœå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7731e26c0f14c66bc4f813dcde7a88c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?) å®é™…ä¸Šæ˜¯ 6 ä¸ªå±æ€§ï¼Œè¿˜æœ‰ä¸€ä¸ª `lastCall` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ¨¡æ‹Ÿçš„å‡½æ•°è¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå­˜åœ¨ã€‚

| å±æ€§åç§°            | å±æ€§å«ä¹‰                                                                                    |
| ------------------- | ------------------------------------------------------------------------------------------- |
| calls               | åŒ…å«å¯¹æ­¤æ¨¡æ‹Ÿå‡½æ•°è¿›è¡Œçš„æ‰€æœ‰è°ƒç”¨çš„è°ƒç”¨å‚æ•°çš„æ•°ç»„ã€‚æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯è°ƒç”¨æœŸé—´ä¼ é€’çš„å‚æ•°æ•°ç»„    |
| contexts            | åŒ…å«æ¨¡æ‹Ÿå‡½æ•°çš„æ‰€æœ‰è°ƒç”¨çš„ä¸Šä¸‹æ–‡çš„æ•°ç»„                                                        |
| instances           | ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å·²ä½¿ç”¨é€šè¿‡ new æ¨¡æ‹Ÿå‡½æ•°å®ä¾‹åŒ–çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹                               |
| invocationCallOrder | åŒ…å«è¢«è°ƒç”¨çš„é¡ºåº                                                                            |
| results             | åŒ…å«æ¨¡æ‹Ÿå‡½æ•°çš„æ‰€æœ‰è°ƒç”¨çš„ä¸Šä¸‹æ–‡çš„æ•°ç»„                                                        |
| lastCall            | åŒ…å«å¯¹æ­¤æ¨¡æ‹Ÿå‡½æ•°è¿›è¡Œçš„æœ€åä¸€æ¬¡è°ƒç”¨çš„è°ƒç”¨å‚æ•°çš„æ•°ç»„ã€‚å¦‚æœå‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå®ƒå°†è¿”å›`undefined` |

å…‰çœ‹ä»‹ç»å¯èƒ½ä¸è¶³ä»¥è®©æˆ‘ä»¬äº†è§£åˆ°åº•æ˜¯å¦‚ä½•ç©çš„ï¼Œç»§ç»­å‘ä¸‹çœ‹ï¼š

- **calls**

> åŒ…å«å¯¹æ­¤æ¨¡æ‹Ÿå‡½æ•°è¿›è¡Œçš„æ‰€æœ‰è°ƒç”¨çš„è°ƒç”¨å‚æ•°çš„æ•°ç»„ã€‚æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯è°ƒç”¨æœŸé—´ä¼ é€’çš„å‚æ•°æ•°ç»„

```js
//mockProperty.test.js
test(".mock.calls", () => {
  const mockFun = jest.fn(() => {});
  mockFun(1);
  mockFun(2);
  console.log("%c Line:27 ğŸ¯ mockFun", "color:#b03734", mockFun.mock);
});
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7af149445ab6472182032b3f7c9fc275~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?) å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`mockFun` æ–¹æ³•è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œåˆ†åˆ«ä¼ äº†`1ï¼Œ2`ä¸¤ä¸ªå‚æ•°ï¼Œæ‰“å°ç»“æœä¸­ `calls` åˆ™æ˜¯è®°å½•æ¯æ¬¡è°ƒç”¨çš„å…¥å‚ã€‚ å³ä½¿è°ƒç”¨çš„æ—¶å€™æ²¡æœ‰ä¼ å‚æ•°ï¼Œ `calls` ä¾æ—§ä¼šè®°å½•è°ƒç”¨çš„æ¬¡æ•°ã€‚

```js
test(".mock.calls", () => {
  const mockFun = jest.fn(() => {});
  mockFun();
  mockFun();
  console.log("%c Line:27 ğŸ¯ mockFun", "color:#b03734", mockFun.mock.calls);
});
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cd51e87d3f0436097622778575a4ca1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

- **contexts**

> åŒ…å«æ¨¡æ‹Ÿå‡½æ•°çš„æ‰€æœ‰è°ƒç”¨çš„ä¸Šä¸‹æ–‡çš„æ•°ç»„

```js
test(".mock.contexts", () => {
  const mockFn = jest.fn();
  const thisContext0 = () => {};
  const thisContext1 = () => {};
  const thisContext2 = () => {};
  const boundMockFn = mockFn.bind(thisContext0);
  boundMockFn();
  mockFn.call(thisContext1);
  mockFn.apply(thisContext2);
  console.log("%c Line:55 ğŸ mockFn.mock", "color:#ea7e5c", mockFn.mock);
});
```

æ‰“å°ç»“æœå¦‚ä¸‹

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/14644d093fd74b5e82943bfd4db7dcd2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?) `contexts` ä¸­è®°å½•äº†æœ¬æ¬¡è°ƒç”¨ `this` æ‰€å±ä¸Šä¸‹æ–‡

- **instances**

> ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«å·²ä½¿ç”¨é€šè¿‡ new æ¨¡æ‹Ÿå‡½æ•°å®ä¾‹åŒ–çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹

```js
test(".mock.instances", () => {
  const mockFn = jest.fn();
  const boundMockFn1 = new mockFn();
  const boundMockFn2 = new mockFn();
  const boundMockFn3 = new mockFn();
  console.log(
    "%c Line:55 ğŸ mockFn.mock",
    "color:#ea7e5c",
    mockFn.mock.instances[0] == boundMockFn1
  ); // true
  console.log(
    "%c Line:55 ğŸ mockFn.mock",
    "color:#ea7e5c",
    mockFn.mock.instances[1] == boundMockFn2
  ); // true
  console.log(
    "%c Line:55 ğŸ mockFn.mock",
    "color:#ea7e5c",
    mockFn.mock.instances[2] == boundMockFn3
  ); // true
});
```

- **invocationCallOrder**

> åŒ…å«è¢«è°ƒç”¨çš„é¡ºåº

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44b9975d81c04b75805fb6ca0cdfee9d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

> ä½¿ç”¨ä¸Šé¢çš„ `instance` æµ‹è¯•æ–¹æ³•ï¼Œæ‰“å°ç»“æœ `.mock` å±æ€§ï¼Œå¯ä»¥åœ¨`invocationCallOrder` æ–¹æ³•ä¸­çœ‹åˆ°æ¯ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„é¡ºåºã€‚

- **results**

> åŒ…å«æ¨¡æ‹Ÿå‡½æ•°çš„æ‰€æœ‰è°ƒç”¨çš„ä¸Šä¸‹æ–‡çš„æ•°ç»„

ç”¨çš„æ¯”è¾ƒå¤šçš„å±æ€§ã€‚

> - `'return'`\- è¡¨ç¤ºè°ƒç”¨æ­£å¸¸è¿”å›å®Œæˆã€‚
> - `'throw'`\- è¡¨ç¤ºè°ƒç”¨é€šè¿‡æŠ›å‡ºå€¼å®Œæˆã€‚
> - `'incomplete'`\- è¡¨ç¤ºå‘¼å«å°šæœªå®Œæˆã€‚å¦‚æœæ‚¨ä»æ¨¡æ‹Ÿå‡½æ•°æœ¬èº«æˆ–ä»æ¨¡æ‹Ÿè°ƒç”¨çš„å‡½æ•°ä¸­æµ‹è¯•ç»“æœï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚

```js
//type ä¸º return çš„æƒ…å†µ
test(".mock.result", () => {
  const mockFn = jest.fn(() => {
    return "";
  });
  mockFn(1);
  console.log(
    "%c Line:55 ğŸ mockFn.mock.result",
    "color:#ea7e5c",
    mockFn.mock.results
  );
});
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8806abeaa05415db6411da62b731fb0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

```js
// type ä¸º throw
test(".mock.result", () => {
  const mockFn = jest.fn(() => {
    throw Error("error");
  });
  try {
    mockFn();
  } catch (error) {}
  console.log(
    "%c Line:55 ğŸ mockFn.mock.result",
    "color:#ea7e5c",
    mockFn.mock.results
  );
});
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ec26f2473404b53b338b040b98e21a4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

```js
// type ä¸ºincomplete
test(".mock.result", () => {
  const mockFn = jest.fn(() => {
    console.log(
      "%c Line:55 ğŸ mockFn.mock.results",
      "color:#ea7e5c",
      mockFn.mock.results
    );
  });
  mockFn();
});
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de5c7d4450dd4199bc39401f341e1cc2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

- **lastCall**

> åŒ…å«å¯¹æ­¤æ¨¡æ‹Ÿå‡½æ•°è¿›è¡Œçš„æœ€åä¸€æ¬¡è°ƒç”¨çš„è°ƒç”¨å‚æ•°çš„æ•°ç»„ã€‚å¦‚æœå‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå®ƒå°†è¿”å›`undefined`

```js
test(".mock.lastCall", () => {
  const mockFn = jest.fn(() => {});
  mockFn();
  mockFn(2);
  console.log(
    "%c Line:55 ğŸ mockFn.mock.lastCall",
    "color:#ea7e5c",
    mockFn.mock.lastCall
  );
});
```

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b41bf39ec9404d7fb898664472cd9c76~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

```js
test(".mock.lastCall", () => {
  const mockFn = jest.fn(() => {});
  console.log(
    "%c Line:55 ğŸ mockFn.mock.lastCall",
    "color:#ea7e5c",
    mockFn.mock.lastCall
  );
});
```

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0ce67f92c99487e9af8a0ece0df8086~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•°`f`è¢«è°ƒç”¨äº† 3 æ¬¡ï¼Œè¿”å›`'result1'`ï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œç„¶åè¿”å›`'result2'`ï¼Œå°†æœ‰ä¸€ä¸ª`mock.results`å¦‚ä¸‹æ‰€ç¤ºçš„æ•°ç»„ï¼š

```js
[
  {
    type: "return",
    value: "result1",
  },
  {
    type: "throw",
    value: {
      /* Error instance */
    },
  },
  {
    type: "return",
    value: "result2",
  },
];
```

#### æ¨¡æ‹Ÿå‡½æ•°

- åˆ›å»ºæ¨¡æ‹Ÿå‡½æ•°  
   æ¨¡æ‹Ÿå‡½æ•°æœ‰ä¸‰ç§æ–¹å¼

| æ–¹æ³•       | ä»‹ç»                                                                                                    |
| ---------- | ------------------------------------------------------------------------------------------------------- |
| jest.mock  | æ¨¡å—çš„æ¨¡æ‹Ÿ                                                                                              |
| jest.fn    | jest.fn()æ˜¯åˆ›å»º Mock å‡½æ•°æœ€ç®€å•çš„æ–¹å¼ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰å‡½æ•°å†…éƒ¨çš„å®ç°ï¼Œjest.fn()ä¼šè¿”å› undefined ä½œä¸ºè¿”å›å€¼ |
| jest.spyOn | jest.fn çš„è¯­æ³•ç³–ï¼Œå¯ä»¥ç›‘æ§æ¨¡æ‹Ÿå‡½æ•°çš„è°ƒç”¨æƒ…å†µ                                                            |

ä¸‰ç§æ–¹å¼éƒ½å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿå‡½æ•°ã€‚ jest.mock ä¸å†åšä»‹ç».  
`jest.fn`

```js
onchange = jest.fn(); // è¿”å› undefined
// å¯ä»¥æ¨¡æ‹Ÿå®ç°
onchange = jest.fn(() => console.log("log"));
```

`jest.spyOn`

```js
let car = {
  stop: () => "stop",
};
jest.spyOn(car, "stop").mockImplementation(() => "mock-stop"); // mock-stop
```

- æ¨¡æ‹Ÿå‡½æ•°è¿”å›

  - **mockReturnValue**

  > å‡½æ•°çš„å†…å®¹å°†ä¸ä¼šè¢«æ‰§è¡Œ

  ```js
  let mockFun = jest.fn().mockReturnValue("mockReturnValue");
  mockFun(); // mockReturnValue
  ```

  - **mockReturnValueOnce**

  ```js
  let mockFun = jest
    .fn(() => "returnValue")
    .mockReturnValueOnce("mockReturnValue");
  mockFun(); // mockReturnValue
  mockFun(); // returnValue
  ```

  - **mockResolvedValue**

  ```js
  let mockFun = jest
    .fn(() => "returnValue")
    .mockResolvedValue("mockReturnValue");
  mockFun(); // Promise { 'mockReturnValue' }
  ```

  - **mockResolvedValueOnce**

  ```js
  let mockFun = jest
    .fn(() => "returnValue")
    .mockResolvedValue("mockReturnValue");
  mockFun(); // Promise { 'mockReturnValue' }
  mockFun(); // Promise { 'returnValue' }
  ```

  - **mockRejectedValue**

  ```js
  let mockFun = jest
    .fn(() => "returnValue")
    .mockRejectedValue("mockReturnValue");
  await mockFun().catch((err) => {
    console.log(err); // mockReturnValue
  });
  ```

  - **mockRejectedValueOnce**  
     åŒä¸Š

  é™¤äº†å•ç‹¬ä½¿ç”¨è¿˜å¯ä»¥è¿åœ¨ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š

  ```js
  let mockFun = jest
    .fn(() => "returnValue")
    .mockReturnValue("default")
    .mockReturnValueOnce("first")
    .mockReturnValueOnce("two")
    .mockResolvedValueOnce("resolved")
    .mockRejectedValueOnce("rejected");

  mockFun(); // first
  mockFun(); // two
  mockFun(); // Promise { 'resolved' }
  mockFun(); // Promise { <rejected> 'rejected' }
  mockFun(); // default
  ```

#### æµ‹è¯•

ä¸€èˆ¬å‡½æ•°æµ‹è¯•ä¸»è¦åˆ†ä¸ºå‡ ç§ï¼š

- æµ‹è¯•å‡½æ•°çš„è°ƒç”¨æƒ…å†µ
- æµ‹è¯•å‡½æ•°çš„è¿”å›å€¼

æˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»äº†è§£åˆ°äº†`mockFun.mock`å±æ€§ï¼Œä»¥åŠ`mockFun` çš„åˆ›å»ºæ–¹å¼ã€‚ä¸‹é¢è¿›å…¥æœ¬å°èŠ‚çš„æ ¸å¿ƒ,å¦‚ä½•æµ‹è¯•å‡½æ•°.

- **å‡½æ•°è°ƒç”¨** é€šè¿‡ `.mocks.calls` å±æ€§çš„é•¿åº¦ï¼Œåˆ¤æ–­å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨ã€è°ƒç”¨çš„æ¬¡æ•°ã€è°ƒç”¨çš„å‚æ•°ã€‚

  - å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨

  ```js
  test(".mock.calls", () => {
    const mockFun = jest.fn(() => {});
    mockFun();
    expect(mockFun.mock.calls.length).toBe(1);
    mockFun();
    expect(mockFun.mock.calls.length).toBe(2); // ok
  });
  ```

  - å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°

  ```js
  test(".mock.calls", () => {
    const mockFun = jest.fn(() => {});
    mockFun(1);
    mockFun();
    expect(mockFun.mock.calls[0][0]).toBe(1); // ok
    expect(mockFun.mock.calls[0][1]).toBeUndefined(); // ok
  });
  ```

- **å‡½æ•°è¿”å›** é€šè¿‡ `.mock.results` å±æ€§åˆ¤æ–­å‡½æ•°çš„ç»“æœ

```js
test(".mock.calls", () => {
  const mockFun = jest.fn((params) => params);
  mockFun(1);
  mockFun(2);
  expect(mockFun.mock.result[0].value).toBe(1); // ok
  expect(mockFun.mock.result[1].value).toBe(2); // ok
});
```

#### è‡ªå®šä¹‰åŒ¹é…å™¨

åœ¨æµ‹è¯•ä¸€èŠ‚ï¼Œå¯ä»¥çœ‹åˆ°è¦åˆ¤æ–­ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨ã€è¿”å›ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œæ˜¯å¦æœ‰ç®€å•çš„æ–¹å¼èƒ½å¤Ÿæ–­è¨€å‡½æ•°æ˜¯å¦è°ƒç”¨ä¸è¿”å›å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š

- æ˜¯å¦è¢«è°ƒç”¨ `toBeCalled`ä¹Ÿå«åš `toHaveBeenCalled`

```js
const fun = jest.fn();
expect(fun).toBeCalled(); // error
fun();
expect(fun).toBeCalled(); // ok
```

- è°ƒç”¨æ¬¡æ•° `toHaveBeenCalledTimes`
- è°ƒç”¨å‚æ•° `toHaveBeenCalledWith`
- æ˜¯å¦æœ‰è¿”å›å€¼(æ²¡æœ‰æŠ›å‡ºé”™è¯¯) `toHaveReturned`
- è¿”å›å€¼ `toHaveReturnedWith`

### å®šæ—¶å™¨

| API                  | ä½œç”¨                                                                                                                                                  |
| -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| useFakeTimers        | å¯¹æ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯•ä½¿ç”¨å‡è®¡æ—¶å™¨ï¼Œç›´åˆ°åŸå§‹è®¡æ—¶å™¨æ¢å¤ä¸º`jest.useRealTimers()`.                                                                           |
| useRealTimers        | æ¢å¤å…¨å±€æ—¥æœŸã€æ€§èƒ½ã€æ—¶é—´å’Œè®¡æ—¶å™¨ API çš„åŸå§‹å®ç°.                                                                                                      |
| runAllTimers         | æ‰§è¡Œæ‰€æœ‰æŒ‚èµ·çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡.                                                                                                                         |
| runOnlyPendingTimers | ä»…æ‰§è¡Œå½“å‰æŒ‚èµ·çš„å®ä»»åŠ¡ï¼ˆå³ï¼Œä»…æ‰§è¡Œåˆ°æ­¤æ—¶æˆ–`setInterval()`ä¹‹å‰å·²æ’é˜Ÿçš„ä»»åŠ¡ï¼‰ã€‚å¦‚æœä»»ä½•å½“å‰æŒ‚èµ·çš„å®ä»»åŠ¡å®‰æ’æ–°çš„å®ä»»åŠ¡ï¼Œåˆ™è¿™äº›æ–°ä»»åŠ¡å°†ä¸ä¼šè¢«æ­¤è°ƒç”¨æ‰§è¡Œã€‚ |
| advanceTimersByTime  | advanceTimersByTime(n) æ‰€æœ‰è®¡æ—¶å™¨éƒ½ä¼šæå‰`n`æ¯«ç§’                                                                                                      |

advanceTimersByTime

- **useFakeTimes**

> å¯¹æ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯•ä½¿ç”¨å‡è®¡æ—¶å™¨ï¼Œç›´åˆ°åŸå§‹è®¡æ—¶å™¨æ¢å¤ä¸º`jest.useRealTimers()`

> 1ã€è¿™æ˜¯ä¸€ä¸ªå…¨å±€æ€§çš„æ“ä½œã€‚æ— è®ºæ˜¯åœ¨æµ‹è¯•æ–‡ä»¶çš„é¡¶éƒ¨è¿˜æ˜¯æŸä¸ªæµ‹è¯• case ä¸­ã€‚  
> 2ã€ä¼šè¢«æ›¿æ¢çš„æ–¹æ³•åŒ…æ‹¬`Date`,Â `performance.now()`,Â `queueMicrotask()`,Â `setImmediate()`,Â `clearImmediate()`,Â `setInterval()`,Â `clearInterval()`,Â `setTimeout()`,`clearTimeout()`ã€‚  
> 3ã€åœ¨ Node ç¯å¢ƒä¸­`process.hrtime`ï¼Œ`process.nextTick()`  
> 4ã€åœ¨ JSDOM ç¯å¢ƒä¸­`requestAnimationFrame()`,`cancelAnimationFrame()`,Â `requestIdleCallback()`,`cancelIdleCallback()`ä¹Ÿä¼šè¢«æ›¿æ¢ã€‚

```js
function timerGame(callback) {
  console.log("Ready....go!");
  setTimeout(() => {
    console.log("Times up -- stop!");
    callback && callback();
  }, 1000);
}
const callback = jest.fn(() => "callback");
jest.spyOn(global, "setTimeout");
timerGame(callback);
expect(setTimeout).toHaveBeenCalledTimes(1); // ok
expect(setTimeout).toHaveBeenLastCalledWith(expect.any(Function), 1000); // ok
expect(callback).not.toBeCalled(); // ok
```

åœ¨æ­¤ demo ä¸­ï¼Œ

- é€šè¿‡ `spyOn` æ–¹æ³•ç›‘å¬ `setTimeout` æ–¹æ³• ã€‚
- é€šè¿‡ `toHaveBeenCalledTimes` åˆ¤æ–­`setTimeout`æ–¹æ³•æ˜¯å¦è¢«æ‰§è¡Œ.

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªèƒ½ç¡®å®š`setTimeout`æ–¹æ³•æ˜¯å¦æœ‰è¢«è°ƒç”¨ï¼Œä½†`callback` æ–¹æ³•æ˜¯å¦åœ¨ 1 ç§’ä¹‹åè°ƒç”¨æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ç¡®å®šæˆ‘ä»¬çš„æ–¹æ³•åœ¨ 1 ç§’ä¹‹åè¢«è°ƒç”¨äº†å‘¢ï¼Ÿå°±éœ€è¦ç”¨åˆ°`runAllTimers` æ–¹æ³•ï¼Œæˆ‘ä»¬å¾€ä¸‹çœ‹ã€‚

- **runAllTimers**

> æ‰§è¡Œæ‰€æœ‰æŒ‚èµ·çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

è¡¥å……ä¸Šé¢çš„æµ‹è¯•æ¡ˆä¾‹

```js
jest.useFakeTimers();
const callback = jest.fn(() => "callback");
jest.spyOn(global, "setTimeout");
timerGame(callback);

expect(setTimeout).toHaveBeenCalledTimes(1);
expect(setTimeout).toHaveBeenLastCalledWith(expect.any(Function), 1000);

expect(callback).not.toBeCalled();

jest.runAllTimers();
expect(callback).toBeCalled(); // ok
```

- **runOnlyPendingTimers**

```js
function timerGame(callback) {
  console.log("Ready....go!");
  setTimeout(() => {
    console.log("Times up -- stop!");
    callback && callback();
    timerGame(callback);
  }, 1000);
}
```

å¦‚æœæˆ‘ä»¬çš„å‡½æ•°ä¸­å­˜åœ¨é€’å½’è°ƒç”¨çš„æƒ…å†µï¼Œåœ¨è¿è¡Œæµ‹è¯• case çš„æ—¶å€™å°±ä¼šä¸æ–­çš„æ‰§è¡Œã€‚è€Œæˆ‘ä»¬çš„ç›®æ ‡åªè¦ç¡®å®š`callback`æ˜¯å¦æœ‰è¢«æ‰§è¡Œï¼Œ åªéœ€è¦æµ‹è¯•ä¸€æ¬¡å³å¯ã€‚æ”¹å†™æˆ‘ä»¬çš„æµ‹è¯• case ã€‚

```js
jest.useFakeTimers();
const callback = jest.fn(() => "callback");
jest.spyOn(global, "setTimeout");
timerGame(callback);

expect(setTimeout).toHaveBeenCalledTimes(1);
expect(setTimeout).toHaveBeenLastCalledWith(expect.any(Function), 1000);

expect(callback).not.toBeCalled();

jest.runOnlyPendingTimers();
expect(callback).toBeCalled(); // ok
```

- **advanceTimersByTime**

```js
jest.useFakeTimers();
const callback = jest.fn(() => "callback");
jest.spyOn(global, "setTimeout");
timerGame(callback);

expect(setTimeout).toHaveBeenCalledTimes(1);
expect(setTimeout).toHaveBeenLastCalledWith(expect.any(Function), 1000);

expect(callback).not.toBeCalled();

//jest.runAllTimers();
//jest.advanceTimersByTime();
expect(callback).toBeCalled(); // ok
```

åœ¨è¿™é‡Œæˆ‘ä»¬ä¸å†ä½¿ç”¨ `runAllTimes`,è€Œæ˜¯é€šè¿‡ `advanceTimersByTime`æ¥æå‰æ‰§è¡Œ`callback`

è¯¦ç»†è¯·çœ‹ï¼š [jestjs.io/docs/jest-oâ€¦](https://jestjs.io/docs/jest-object#jestusefaketimersfaketimersconfig)

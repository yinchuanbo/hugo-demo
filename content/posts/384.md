---
title: "React é”™è¯¯å¤„ç†ï¼šæœ€ä½³å®è·µ"
date: 2023-03-12T16:25:32+08:00
---

## React ä¸­é”™è¯¯å¤„ç†çš„é‡è¦æ€§

é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆåœ¨ React ä¸­åšä¸€äº›é”™è¯¯æ•è·å¤„ç†ï¼Ÿ

ç­”æ¡ˆå¾ˆç®€å•ï¼šè‡ª React 16 èµ·ï¼Œä»»ä½•æœªè¢«é”™è¯¯è¾¹ç•Œæ•è·çš„é”™è¯¯å°†ä¼šå¯¼è‡´æ•´ä¸ª React ç»„ä»¶æ ‘è¢«å¸è½½ã€‚åœ¨è¿™ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå³ä¾¿ç»„ä»¶çš„ UI æ˜¯æ®‹ç¼ºæˆ–é”™è¯¯çš„ï¼Œç»„ä»¶ä¹Ÿä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ç°åœ¨ï¼Œå³ä½¿æ˜¯ UI ä¸Šçš„æŸä¸ªæ— å…³ç´§è¦çš„éƒ¨åˆ†ï¼Œç”šè‡³æ˜¯æŸä¸ªæ— æ³•æ§åˆ¶çš„å¤–éƒ¨åº“ä¸­ï¼Œå‡ºç°äº†ä¸€ä¸ªå¾®ä¸è¶³é“çš„é”™è¯¯ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´æ•´ä¸ªé¡µé¢å—åˆ°ç ´åï¼Œå¹¶ä¸ºç”¨æˆ·æ¸²æŸ“å‡ºä¸€ä¸ªç™½å±ã€‚

å‰ç«¯å¼€å‘äººå‘˜ä»æœªæœ‰è¿‡å¦‚æ­¤å¼ºå¤§çš„ç ´ååŠ› ğŸ˜…

## JavaScript ä¸­çš„ try/catch

åœ¨å¸¸è§„çš„ JavaScript ä»£ç ä¸­æ•è·é‚£äº›ä»¤äººè®¨åŒçš„é”™è¯¯ï¼Œå¤„ç†æ–¹æ³•é€šå¸¸éå¸¸ç®€å•ã€‚

æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„ try/catch è¯­å¥ï¼Œå®ƒçš„ç”¨æ³•ä¸è¨€è‡ªæ˜ï¼šå°è¯•åšä¸€äº›äº‹æƒ…ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±æ•è·åˆ°é”™è¯¯å¹¶é‡‡å–æªæ–½å¤„ç†å®ƒï¼š

```js
try {
  // if we're doing something wrong, this might throw an error
  doSomething();
} catch (e) {
  // if error happened, catch it and do something with it without stopping the app
  // like sending this error to some logging service
}
```

åŒæ ·çš„ä»£ç ä¹Ÿé€‚ç”¨äº async å‡½æ•°ä¸­ï¼š

```js
try {
  await fetch("/bla-bla");
} catch (e) {
  // oh no, the fetch failed! We should do something about it!
}
```

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ Promiseï¼Œæˆ‘ä»¬æœ‰ä¸“é—¨é’ˆå¯¹ä»–ä»¬çš„æ•è·æ–¹æ³•ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Promise çš„ API é‡æ–°ç¼–å†™å‰é¢çš„ fetch ç¤ºä¾‹ï¼Œå®ƒå°†å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
fetch("/bla-bla")
  .then((result) => {
    // if a promise is successful, the result will be here
    // we can do something useful with it
  })
  .catch((e) => {
    // oh no, the fetch failed! We should do something about it!
  });
```

å®ƒä»¬çš„æ¦‚å¿µç›¸åŒï¼Œåªæ˜¯å®ç°æœ‰ç‚¹ä¸åŒï¼Œæ‰€ä»¥åœ¨æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘å°†å¯¹æ‰€æœ‰é”™è¯¯ä½¿ç”¨ try/catch è¯­æ³•ã€‚

## React ä¸­çš„ try/catch

å½“æ•è·åˆ°é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹é”™è¯¯åšä¸€äº›å¤„ç†ã€‚é™¤äº†ä¸ŠæŠ¥ä¸€æ¡é”™è¯¯æ—¥å¿—ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿæ›´å‡†ç¡®çš„è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç”¨æˆ·åšä»€ä¹ˆå‘¢ï¼Ÿè®©ç”¨æˆ·çœ‹åˆ°ä¸€ä¸ªç™½å±é¡µé¢æˆ–æ®‹ç¼ºçš„é¡µé¢ï¼Œè¿™æ ·çš„ç”¨æˆ·ä½“éªŒæå…¶ä¸å‹å¥½ã€‚

æœ€ç›´æ¥çš„åšæ³•æ˜¯ï¼Œåœ¨ç­‰å¾…æˆ‘ä»¬ä¿®å¤çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºç”¨æˆ·æ¸²æŸ“ä¸€äº›æœ‰ç”¨çš„å†…å®¹ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ catch è¯­å¥ä¸­åšä»»ä½•æƒ³åšçš„äº‹æƒ…ï¼ŒåŒ…æ‹¬è®¾ç½®çŠ¶æ€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š

```js
const SomeComponent = () => {
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    try {
      // do something like fetching some data
    } catch (e) {
      // oh no! the fetch failed, we have no data to render!
      setHasError(true);
    }
  });

  // something happened during fetch, lets render some nice error screen
  if (hasError) return <SomeErrorScreen />;

  // all's good, data is here, let's render it
  return <SomeComponentContent {...datasomething} />;
};
```

å¦‚æœæˆ‘ä»¬è¯·æ±‚æ•°æ®å¤±è´¥äº†ï¼Œå°±æŠŠé”™è¯¯çŠ¶æ€è¢«ç½®ä¸º trueï¼Œç„¶åä¸ºç”¨æˆ·æ¸²æŸ“å‡ºä¸€ä¸ªå…œåº•é¡µé¢ï¼Œå¹¶å¸¦æœ‰ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚ç”¨äºã€Œè”ç³»æˆ‘ä»¬ã€çš„ç”µè¯å·ç ã€‚

è¿™ç§å¤„ç†é”™è¯¯çš„æ–¹å¼éå¸¸ç®€å•ï¼Œé€‚ç”¨äºé‚£äº›ç®€å•çš„ã€å¯é¢„æµ‹çš„ ä»¥åŠç‰¹å®šçš„ç”¨æˆ·åœºæ™¯ï¼Œä¾‹å¦‚å¤„ç†å¤±è´¥çš„ fetch è¯·æ±‚ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæƒ³è¦æ•è·åˆ°ç»„ä»¶ä¸­æ‰€æœ‰å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸é¢ä¸´ä¸€äº›æŒ‘æˆ˜å’Œé™åˆ¶ã€‚

### é™åˆ¶ 1ï¼šuseEffect ä¸èƒ½è¢« try/catch åŒ…è£¹

å¦‚æœæˆ‘ä»¬ç”¨ try/catch åŒ…è£¹ useEffectï¼Œå®ƒå°†æ— æ³•å·¥ä½œï¼š

```js
try {
  useEffect(() => {
    throw new Error("Hulk smash!");
  }, []);
} catch (e) {
  // useEffect throws, but this will never be called
}
```

è¿™æ˜¯å› ä¸º useEffect åœ¨æ¸²æŸ“åè¢«å¼‚æ­¥è°ƒç”¨ï¼Œæ‰€ä»¥ä» try/catch çš„è§’åº¦æ¥çœ‹ï¼Œè¯¸äº‹çš†é¡ºåˆ©ã€‚è¿™ç‚¹ä¸ [Promise](https://www.developerway.com/posts/fetching-in-react-lost-promises#part1) ç±»ä¼¼ï¼šå¦‚æœæˆ‘ä»¬ä¸ç­‰å¾…å¼‚æ­¥çš„æ‰§è¡Œç»“æœï¼ŒJavaScript å°†ç»§ç»­è¿›è¡Œå…¶å®ƒä¸šåŠ¡ï¼Œç›´åˆ°å®Œæˆ Promise åè¿”å›ï¼Œå¹¶ä¸”åªæ‰§è¡Œ useEffectï¼ˆæˆ– Promiseï¼‰çš„å†…éƒ¨ä»£ç ã€‚try/catch å†…çš„ä»£ç å—å°†è¢«æ‰§è¡Œï¼Œä½†åœ¨é‚£æ—¶ try/catch å·²ç»æ¶ˆå¤±å¾ˆä¹…äº†ã€‚

ä¸ºäº†æ•è· useEffect å†…éƒ¨çš„é”™è¯¯ï¼Œtry/catch ä¹Ÿåº”æ”¾åœ¨å†…éƒ¨ï¼š

```js
useEffect(() => {
  try {
    throw new Error("Hulk smash!");
  } catch (e) {
    // this one will be caught
  }
}, []);
```

è¿™ç§æ–¹æ¡ˆé€‚ç”¨äºä»»ä½•ä½¿ç”¨ useEffect æˆ–å…¶å®ƒå¼‚æ­¥åœºæ™¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å°† try/catch æ‹†åˆ†ä¸ºå¤šä¸ªå—ï¼šæ¯ä¸ª Hook ä¸­éƒ½è¦ä¸€ä¸ª try/catchã€‚

### é™åˆ¶ 2ï¼štry/catch æ— æ³•æ•è·å­ç»„ä»¶ä¸­çš„é”™è¯¯

try/catch æ— æ³•æ•è·å­ç»„ä»¶ä¸­å‘ç”Ÿçš„ä»»ä½•äº‹æƒ…ã€‚å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¸èƒ½è¿™æ ·åšï¼š

```js
const Component = () => {
  let child;

  try {
    child = <Child />;
  } catch (e) {
    // useless for catching errors inside Child component, won't be triggered
  }

  return child;
};
```

æˆ–è€…è¿™æ ·ï¼š

```js
const Component = () => {
  try {
    return <Child />;
  } catch (e) {
    // still useless for catching errors inside Child component, won't be triggered
  }
};
```

è¿™æ˜¯å› ä¸ºåœ¨æˆ‘ä»¬å†™äº† `<Child />` è¿™ä¸ªä»£ç æ—¶ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„æ¸²æŸ“è¿™ä¸ªç»„ä»¶ã€‚æˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªç»„ä»¶çš„ Elementï¼Œè¿™ä»…ä»…æ˜¯å¯¹ç»„ä»¶åšçš„å®šä¹‰ã€‚å®ƒä½œä¸ºä¸€ä¸ªåŒ…å« typeã€props ç­‰å¿…è¦ä¿¡æ¯çš„å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ React ä¼šä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå¹¶è§¦å‘ç»„ä»¶æ¸²æŸ“ã€‚ç»„ä»¶æ¸²æŸ“æ—¶ï¼Œtry/catch å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ Promise å’Œ useEffect ç±»ä¼¼ã€‚

### é™åˆ¶ 3ï¼štry/catch æ— æ³•åœ¨æ¸²æŸ“æœŸé—´è®¾ç½® state

å¦‚æœæˆ‘ä»¬è¦æ•è· useEffect ä»¥åŠ callback ä¹‹å¤–çš„é”™è¯¯ï¼ˆå³ï¼Œåœ¨ç»„ä»¶æ¸²æŸ“æœŸé—´å‘ç”Ÿçš„é”™è¯¯ï¼‰ï¼Œé‚£ä¹ˆå¤„ç†å®ƒä»¬çš„æ–¹æ³•å°±ä¸å†æ˜¯é‚£ä¹ˆç®€å•äº†ï¼šå› ä¸ºæ¸²æŸ“æœŸé—´ä¸å…è®¸çŠ¶æ€æ›´æ–°ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåƒè¿™æ ·æ›´æ–°çŠ¶æ€çš„ä»£ç åªä¼šå¯¼è‡´æ— é™å¾ªç¯çš„é‡æ–°æ¸²æŸ“ï¼š

```js
const Component = () => {
  const [hasError, setHasError] = useState(false);

  try {
    doSomethingComplicated();
  } catch (e) {
    // don't do that! will cause infinite loop in case of an error
    // see codesandbox below with live example
    setHasError(true);
  }
};
```

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè¿”å›é’ˆå¯¹é”™è¯¯çš„å…œåº•å†…å®¹ï¼Œè€Œä¸æ˜¯è®¾ç½®çŠ¶æ€ï¼š

```js
const Component = () => {
  try {
    doSomethingComplicated();
  } catch (e) {
    // this allowed
    return <SomeErrorScreen />;
  }
};
```

ä½†æ˜¯ï¼Œæ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™ä¹ˆå¤„ç†æœ‰ç‚¹éº»çƒ¦ï¼Œå¹¶è¿«ä½¿æˆ‘ä»¬ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†åŒä¸€ç»„ä»¶ä¸­çš„é”™è¯¯ï¼šçŠ¶æ€ä¸º useEffect å’Œå›è°ƒè®¾ç½® stateï¼Œä»¥åŠç›´æ¥è¿”å›å…œåº•å†…å®¹ã€‚

```js
// while it will work, it's super cumbersome and hard to maitain, don't do that
const SomeComponent = () => {
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    try {
      // do something like fetching some data
    } catch (e) {
      // can't just return in case of errors in useEffect or callbacks
      // so have to use state
      setHasError(true);
    }
  });

  try {
    // do something during render
  } catch (e) {
    // but here we can't use state, so have to return directly in case of an error
    return <SomeErrorScreen />;
  }

  // and still have to return in case of error state here
  if (hasError) return <SomeErrorScreen />;

  return <SomeComponentContent {...datasomething} />;
};
```

æ€»ç»“æœ¬èŠ‚ï¼šå¦‚æœæˆ‘ä»¬åœ¨ React ä¸­ä»…ä»…ä½¿ç”¨ try/catch æ¥å¤„ç†é”™è¯¯ï¼Œè¦ä¹ˆä¼šé”™è¿‡å¤§éƒ¨åˆ†é”™è¯¯ï¼Œè¦ä¹ˆä¼šå°†æ¯ä¸ªç»„ä»¶å˜æˆä¸€å †æ— æ³•ç†è§£çš„ä»£ç ï¼Œè€Œä¸”è¿™äº›ä»£ç æœ¬èº«ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯ã€‚

å¹¸è¿çš„æ˜¯ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ã€‚

## é”™è¯¯è¾¹ç•Œï¼ˆError Boundariesï¼‰çš„ä½¿ç”¨

ä¸ºäº†çªç ´ä¸Šè¿°é™åˆ¶ï¼ŒReact ä¸ºæˆ‘ä»¬æä¾›äº†æ‰€è°“çš„ â€œé”™è¯¯è¾¹ç•Œï¼ˆ[Error Boundaries](https://reactjs.org/docs/error-boundaries.html)ï¼‰â€ï¼šé”™è¯¯è¾¹ç•Œæ˜¯ä¸€ç§ React ç»„ä»¶ï¼Œå¯ä»¥æ•è·å‘ç”Ÿåœ¨å…¶å­ç»„ä»¶æ ‘ä»»ä½•ä½ç½®çš„ JavaScript é”™è¯¯ï¼Œå®ƒä»¥æŸç§æ–¹å¼å°†å¸¸è§„ç»„ä»¶è½¬æ¢ä¸º try/catch è¯­å¥ã€‚é”™è¯¯è¾¹ç•Œå¯ä»¥æ•è·å‘ç”Ÿåœ¨æ•´ä¸ªå­ç»„ä»¶æ ‘çš„æ¸²æŸ“æœŸé—´ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥åŠæ„é€ å‡½æ•°ä¸­çš„é”™è¯¯ï¼Œä½†æ˜¯å®ƒæ— æ³•æ•è·å…¶è‡ªèº«çš„é”™è¯¯ã€‚

é”™è¯¯è¾¹ç•Œçš„å…¸å‹ç”¨æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```jsx
const Component = () => {
  return (
    <ErrorBoundary>
      <SomeChildComponent />
      <AnotherChildComponent />
    </ErrorBoundary>
  );
};
```

åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿™äº›ç»„ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªæˆ–å…¶å­ç»„ä»¶å‡ºç°é—®é¢˜ï¼Œéƒ½å°†æ•è·å¹¶å¤„ç†è¯¥é”™è¯¯ã€‚

ä½†æ˜¯ React å¹¶æœªæä¾›ç»™æˆ‘ä»¬ç»„ä»¶æœ¬èº«ï¼Œå®ƒåªæ˜¯ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå®ç°å®ƒçš„å·¥å…·ã€‚æœ€ç®€å•çš„å®ç°æ˜¯è¿™æ ·çš„ï¼š

```jsx
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    // initialize the error state
    this.state = { hasError: false };
  }

  // if an error happened, set the state to true
  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  render() {
    // if error happened, return a fallback component
    if (this.state.hasError) {
      return <>Oh no! Epic fail!</>;
    }

    return this.props.children;
  }
}
```

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¸¸è§„çš„ç±»ç»„ä»¶ï¼ˆè¿™é‡Œåªèƒ½ç”¨ç±»ç»„ä»¶ï¼Œå› ä¸ºæ²¡æœ‰ç”¨äºé”™è¯¯è¾¹ç•Œçš„ Hooksï¼‰ï¼Œå¹¶å®šä¹‰äº† getDerivedStateFromError æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ç»„ä»¶è½¬æ¢ä¸ºä¸€ä¸ªé”™è¯¯è¾¹ç•Œã€‚

æ•è·åˆ°é”™è¯¯å¹¶å°†é”™è¯¯ä¿¡æ¯å‘é€åˆ°æŸä¸ªåœ°æ–¹ï¼Œè¿™æ ·å¯ä»¥é€šçŸ¥åˆ° on-callï¼ˆå€¼ç­ï¼‰çš„äººï¼Œä¹Ÿæ˜¯ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚ä¸ºæ­¤ï¼Œé”™è¯¯è¾¹ç•Œä¸ºæˆ‘ä»¬æä¾›äº† componentDidCatch æ–¹æ³•ï¼š

```jsx
class ErrorBoundary extends React.Component {
  // everything else stays the same

  componentDidCatch(error, errorInfo) {
    // send error to somewhere here
    log(error, errorInfo);
  }
}
```

åœ¨è®¾ç½®äº†é”™è¯¯è¾¹ç•Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å®ƒåšä»»ä½•æˆ‘ä»¬æƒ³åšçš„äº‹æƒ…ï¼Œå’Œå…¶ä»–ç»„ä»¶æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°† fallback ä½œä¸º props æ¥æé«˜å®ƒçš„å¯å¤ç”¨æ€§ï¼š

```jsx
render() {
  // if error happened, return a fallback component
  if (this.state.hasError) {
    return this.props.fallback;
  }

  return this.props.children;
}
```

ç„¶åè¿™æ ·ä½¿ç”¨å®ƒï¼š

```jsx
const Component = () => {
  return (
    <ErrorBoundary fallback={<>Oh no! Do something!</>}>
      <SomeChildComponent />
      <AnotherChildComponent />
    </ErrorBoundary>
  );
};
```

æˆ–è€…æˆ‘ä»¬å¯èƒ½éœ€è¦å…¶ä»–ä¸œè¥¿ï¼Œæ¯”å¦‚åœ¨å•å‡»æŒ‰é’®æ—¶é‡ç½® stateï¼ŒåŒºåˆ†é”™è¯¯ç±»å‹ï¼Œæˆ–è€…å°†é”™è¯¯æ¨åˆ°æŸä¸ª context ä¸­ã€‚

ç„¶è€Œï¼Œé”™è¯¯è¾¹ç•Œä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒå¹¶ä¸èƒ½æ•è·åˆ°æ‰€æœ‰çš„é”™è¯¯ã€‚

## é”™è¯¯è¾¹ç•Œçš„é™åˆ¶

é”™è¯¯è¾¹ç•Œä»…æ•è·åˆ° React ç”Ÿå‘½å‘¨æœŸä¸­å‘ç”Ÿçš„é”™è¯¯ã€‚åœ¨ç”Ÿå‘½å‘¨æœŸä¹‹å¤–å‘ç”Ÿçš„é”™è¯¯ï¼Œæ¯”å¦‚ resolved promiseã€å¸¦æœ‰ setTimeout çš„å¼‚æ­¥ä»£ç ã€å„ç§å›è°ƒå’Œäº‹ä»¶å¤„ç†ç¨‹åºï¼Œå¦‚æœä¸é¢å¤–åšå¤„ç†ï¼Œå°±ä¸ä¼šè¢«æ•è·åˆ°ã€‚

```jsx
const Component = () => {
  useEffect(() => {
    // this one will be caught by ErrorBoundary component
    throw new Error("Destroy everything!");
  }, []);

  const onClick = () => {
    // this error will just disappear into the void
    throw new Error("Hulk smash!");
  };

  useEffect(() => {
    // if this one fails, the error will also disappear
    fetch("/bla");
  }, []);

  return <button onClick={onClick}>click me</button>;
};

const ComponentWithBoundary = () => {
  return (
    <ErrorBoundary>
      <Component />
    </ErrorBoundary>
  );
};
```

é€šå¸¸ï¼Œè¦ä½¿ç”¨å¸¸è§„ try/catch æ¥å¤„ç†æ­¤ç±»é”™è¯¯ã€‚è‡³å°‘åœ¨è¿™ä¸ªåœºæ™¯ä¸­æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ï¼ˆæˆ–å¤šæˆ–å°‘åœ°ï¼‰ä½¿ç”¨ stateï¼šå¤„ç†äº‹ä»¶çš„å›è°ƒå‡½æ•°é€šå¸¸ä¹Ÿæ˜¯è®¾ç½® state çš„åœ°æ–¹ã€‚æ‰€ä»¥ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸¤ç§æ–¹æ³•ç»“åˆèµ·æ¥ï¼Œäºæ˜¯å¯ä»¥è¿™æ ·åšï¼š

```jsx
const Component = () => {
  const [hasError, setHasError] = useState(false);

  // most of the errors in this component and in children will be caught by the ErrorBoundary

  const onClick = () => {
    try {
      // this error will be caught by catch
      throw new Error("Hulk smash!");
    } catch (e) {
      setHasError(true);
    }
  };

  if (hasError) return "something went wrong";

  return <button onClick={onClick}>click me</button>;
};

const ComponentWithBoundary = () => {
  return (
    <ErrorBoundary fallback={"Oh no! Something went wrong"}>
      <Component />
    </ErrorBoundary>
  );
};
```

ä½†æ˜¯æˆ‘ä»¬åˆå›åˆ°äº†åŸç‚¹ï¼šæ¯ä¸ªç»„ä»¶éƒ½éœ€è¦ç»´æŒ â€œé”™è¯¯â€ stateï¼Œæ›´é‡è¦çš„æ˜¯è¿˜è¦å†³å®šå¦‚ä½•å»å¤„ç†å®ƒã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸åœ¨ç»„ä»¶çº§åˆ«å¤„ç†è¿™äº›é”™è¯¯ï¼Œè€Œæ˜¯é€šè¿‡ props æˆ– Context å°†å®ƒä»¬ä¼ æ’­åˆ°å…·æœ‰é”™è¯¯è¾¹ç•Œçš„çˆ¶ç»„ä»¶ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®ä¸€ä¸ªå…¨å±€çš„ â€œfallbackâ€ ç»„ä»¶ï¼š

```jsx
const Component = ({ onError }) => {
  const onClick = () => {
    try {
      throw new Error("Hulk smash!");
    } catch (e) {
      // just call a prop instead of maintaining state here
      onError();
    }
  };

  return <button onClick={onClick}>click me</button>;
};

const ComponentWithBoundary = () => {
  const [hasError, setHasError] = useState();
  const fallback = "Oh no! Something went wrong";

  if (hasError) return fallback;

  return (
    <ErrorBoundary fallback={fallback}>
      <Component onError={() => setHasError(true)} />
    </ErrorBoundary>
  );
};
```

ä½†æ˜¯ï¼Œè¿™è¦é¢å¤–å†™å¾ˆå¤šä»£ç ï¼æˆ‘ä»¬å¿…é¡»ä¸ºæ¸²æŸ“æ ‘ä¸­çš„æ¯ä¸ªå­ç»„ä»¶æ‰§è¡ŒåŒæ ·çš„æ“ä½œã€‚æ›´ä¸ç”¨è¯´ï¼Œæˆ‘ä»¬ç°åœ¨åŸºæœ¬ä¸Šç»´æŠ¤äº†ä¸¤ä¸ªé”™è¯¯çŠ¶æ€ï¼šçˆ¶ç»„ä»¶å’Œé”™è¯¯è¾¹ç•Œã€‚é”™è¯¯è¾¹ç•Œå·²ç»æœ‰äº†å°†é”™è¯¯ä¼ æ’­åˆ°çˆ¶ç»„ä»¶çš„æ‰€æœ‰æœºåˆ¶ï¼Œè€Œæˆ‘ä»¬åœ¨è¿™é‡Œåšäº†é‡å¤çš„å·¥ä½œã€‚

éš¾é“æˆ‘ä»¬ä¸èƒ½ç”¨é”™è¯¯è¾¹ç•Œæ•è·åˆ°å¼‚æ­¥ä»£ç å’Œäº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„é”™è¯¯å—ï¼Ÿ

## é”™è¯¯è¾¹ç•Œæ•è·å¼‚æ­¥é”™è¯¯

æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é”™è¯¯è¾¹ç•Œæ•è·åˆ°æ‰€æœ‰çš„é”™è¯¯ï¼æ·±å—å¤§å®¶å–œæ¬¢çš„ [Dan Abramov](https://twitter.com/dan_abramov) ç»™æˆ‘ä»¬åˆ†äº«äº†ä¸€ä¸ªå¾ˆé…·çš„æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹:[Throwing Error from hook not caught in error boundary Â· Issue #14981 Â· facebook/react](https://github.com/facebook/react/issues/14981#issuecomment-468460187)

è¿™é‡Œçš„æŠ€å·§æ˜¯å…ˆç”¨ try/catch æ•è·è¿™äº›é”™è¯¯ï¼Œç„¶ååœ¨ catch è¯­å¥å†…è§¦å‘æ­£å¸¸çš„ React é‡æ–°æ¸²æŸ“ï¼Œç„¶åå°†è¿™äº›é”™è¯¯é‡æ–°æŠ›å‡ºåˆ°é‡æ–°æ¸²æŸ“ç”Ÿå‘½å‘¨æœŸä¸­ã€‚è¿™æ ·ï¼Œé”™è¯¯è¾¹ç•Œå¯ä»¥åƒå…¶å®ƒé”™è¯¯ä¸€æ ·æ•è·å®ƒä»¬ã€‚ç”±äºçŠ¶æ€æ›´æ–°æ˜¯è§¦å‘é‡æ–°æ¸²æŸ“çš„æ–¹å¼ï¼Œå¹¶ä¸” setState å‡½æ•°å®é™…ä¸Šå¯ä»¥æ¥å—[å‡½æ•°](https://beta.reactjs.org/reference/react/useState#updating-state-based-on-the-previous-state) ä½œä¸ºå‚æ•°ï¼Œå› æ­¤è¯¥è§£å†³æ–¹æ¡ˆååˆ†æƒŠè‰³ã€‚

```jsx
const Component = () => {
  // create some random state that we'll use to throw errors
  const [state, setState] = useState();

  const onClick = () => {
    try {
      // something bad happened
    } catch (e) {
      // trigger state update, with updater function as an argument
      setState(() => {
        // re-throw this error within the updater function
        // it will be triggered during state update
        throw e;
      });
    }
  };
};
```

æœ€åï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªæ–¹æ¡ˆåšä¸€äº›æŠ½è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…åœ¨æ¯ä¸ªç»„ä»¶ä¸­åˆ›å»ºéšæœº stateã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå‘æŒ¥åˆ›æ„ï¼Œåˆ¶ä½œä¸€ä¸ª Hookï¼Œä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªå¼‚æ­¥é”™è¯¯æŠ›å‡ºå·¥å…·ï¼š

```jsx
const useThrowAsyncError = () => {
  const [state, setState] = useState();

  return (error) => {
    setState(() => throw error);
  };
};
```

ç„¶åè¿™æ ·ä½¿ç”¨ï¼š

```jsx
const Component = () => {
  const throwAsyncError = useThrowAsyncError();

  useEffect(() => {
    fetch("/bla")
      .then()
      .catch((e) => {
        // throw async error here!
        throwAsyncError(e);
      });
  });
};
```

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º callback å›è°ƒå‡½æ•°åšä¸€äº›é¢å¤–å¤„ç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```jsx
const useCallbackWithErrorHandling = (callback) => {
  const [state, setState] = useState();

  return (...args) => {
    try {
      callback(...args);
    } catch (e) {
      setState(() => throw e);
    }
  };
};
```

ç„¶åè¿™æ ·ä½¿ç”¨ï¼š

```jsx
const Component = () => {
  const onClick = () => {
    // do something dangerous here
  };

  const onClickWithErrorHandler = useCallbackWithErrorHandling(onClick);

  return <button onClick={onClickWithErrorHandler}>click me!</button>;
};
```

è¿™æ ·å°±ä¸ä¼šæœ‰ä»»ä½•é™åˆ¶äº†ï¼Œååˆ†å®Œç¾ã€‚

## å·²æœ‰çš„å·¥å…· react-error-boundary

å¯¹äºé‚£äº›è®¨åŒé‡æ–°å‘æ˜è½®å­æˆ–è€…å–œæ¬¢ä½¿ç”¨å·²æœ‰çš„å·¥å…·ç±»åº“çš„äººæ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå¼€æºç±»åº“ï¼š[GitHub - bvaughn/react-error-boundary](https://github.com/bvaughn/react-error-boundary)

## æ€»ç»“

è¿™å°±æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›ä»ç°åœ¨å¼€å§‹ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºå‘ç”Ÿäº†ä¸€äº›ä¸å¥½çš„äº‹æƒ…ï¼Œä½ å°†èƒ½å¤Ÿè½»æ¾ä¼˜é›…åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚

æœ¬æ–‡é‡ç‚¹ï¼š

- try/catch ä¸ä¼šæ•è·åƒ useEffect è¿™æ ·çš„ Hooks ä»¥åŠä»»ä½•å­ç»„ä»¶å†…éƒ¨çš„é”™è¯¯
- ErrorBoundary å¯ä»¥æ•è·ç”Ÿå‘½å‘¨æœŸä¸­çš„é”™è¯¯ï¼Œä½†å®ƒä¸ä¼šæ•è·å¼‚æ­¥ä»£ç å’Œäº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„é”™è¯¯
- ä¸ºäº†è®© ErrorBoundary æ•è·åˆ°è¿™äº›é”™è¯¯ï¼Œåªéœ€è¦å…ˆç”¨ try/catch æ•è·å®ƒä»¬ï¼Œç„¶åå°†å®ƒä»¬é‡æ–°æŠ›å›åˆ° React ç”Ÿå‘½å‘¨æœŸ

---
title: "ä»é›¶æ­å»ºå±äºä½ è‡ªå·±çš„å‰ç«¯è§„èŒƒ+è‡ªåŠ¨åŒ–éƒ¨ç½²"
date: 2023-04-10T22:03:36+08:00
---

![ä»é›¶æ­å»ºå±äºä½ è‡ªå·±çš„å‰ç«¯è§„èŒƒ+è‡ªåŠ¨åŒ–éƒ¨ç½²](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1de7244aa5954ec3807e6fd43de2705e~tplv-k3u1fbpfcp-zoom-crop-mark:1512:1512:1512:851.awebp?)  

ä»Šå¤©æƒ³è¦åˆ†äº«çš„æ˜¯å…³äºå‰ç«¯é¡¹ç›®è§„èŒƒä»¥åŠéƒ¨ç½²ä¸Šçº¿çš„æ•´ä½“æµç¨‹ï¼Œä¸»è¦åŒ…å«ï¼š

- ğŸŒˆÂ eslintã€prettier
- ğŸ“¦Â husky
- ğŸ›¡Â git-cz
- âš™ï¸Â åŸºäº nginx éƒ¨ç½²çš„docker
- ğŸŒÂ åœ¨ pull request æ—¶è§¦å‘ CI/CD
- ğŸ¨Â åŸºäº vitest çš„åŠŸèƒ½æµ‹è¯•ï¼ˆè¿˜åœ¨å®Œå–„ä¸­...ï¼‰

é‡ç‚¹è®²è§£çš„æ˜¯åç»­çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå‰é¢çš„é¡¹ç›®è§„èŒƒç®€å•çš„èµ°ä¸€éè¿™ä¸ªæµç¨‹

è¿™ä¸ªæ˜¯ demo çš„ä»“åº“ï¼š[github.com/Jiaynn/autoâ€¦](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FJiaynn%2Fauto-project "https://github.com/Jiaynn/auto-project")

æ¥ä¸‹æ¥å’±ä»¬å°±ç›´å¥”ä¸»é¢˜å§

## åˆå§‹åŒ–

é¦–å…ˆï¼Œæˆ‘ä»¬è‚¯å®šå¾—åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ï¼Œè¿™é‡Œæˆ‘æ˜¯åŸºäº Vite æ­å»ºçš„å…³äº React+TypeScript çš„é¡¹ç›®

```shell
pnpm create vite@latest
```

è¿™æ ·ä¸€ä¸ªåŸºæœ¬çš„æ¶å­å°±æ­å¥½äº†

## ä»£ç è§„èŒƒ

### 1.EditorConfig

`.editorconfig`Â æ˜¯è·¨ç¼–è¾‘å™¨ç»´æŠ¤ä¸€è‡´ç¼–ç é£æ ¼çš„é…ç½®æ–‡ä»¶ï¼Œæœ‰çš„ç¼–è¾‘å™¨ä¼šé»˜è®¤é›†æˆè¯»å–è¯¥é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ã€‚

è¿™å°±è§£å†³äº†åœ¨å›¢é˜Ÿåä½œæ—¶ï¼Œä¸åŒçš„å¼€å‘äººå‘˜ä½¿ç”¨äº†ä¸åŒçš„ç¼–è¾‘å™¨é€ æˆçš„é£æ ¼ä¸ç»Ÿä¸€çš„é—®é¢˜

æ³¨æ„åœ¨ vscode éœ€è¦å®‰è£…æ‰©å±•Â EditorConfig For vs Code

å®‰è£…å®Œæ­¤æ‰©å±•åï¼Œåœ¨ vscode ä¸­ä½¿ç”¨å¿«æ·é”® `ctrl+shift+p`Â æ‰“å¼€å‘½ä»¤å°ï¼Œè¾“å…¥ `Generate .editorcofig`Â å³å¯å¿«é€Ÿç”Ÿæˆ `.editorconfig`Â æ–‡ä»¶ï¼Œå¦‚æœå‘½ä»¤æ²¡ç”Ÿæ•ˆï¼Œç›´æ¥æ‰‹åŠ¨åˆ›å»º`.editorconfig`Â æ–‡ä»¶

```shell
# EditorConfig is awesome: https://EditorConfig.org

# top-most EditorConfig file
root = true

[*]
indent_style = space //ç¼©è¿›é£æ ¼ï¼Œå¯é€‰é…ç½®æœ‰ `tab`Â å’Œ `space`Â 
indent_size = 2      //ç¼©è¿›å¤§å°ï¼Œå¯è®¾å®šä¸º `1-8`Â çš„æ•°å­—ï¼Œæ¯”å¦‚è®¾å®šä¸º `2`Â ï¼Œé‚£å°±æ˜¯ç¼©è¿› `2`Â ä¸ªç©ºæ ¼ã€‚
end_of_line = lf     //æ¢è¡Œç¬¦ï¼Œå¯é€‰é…ç½®æœ‰ `lf`Â ï¼Œ`cr`Â ï¼Œ`crlf`
charset = utf-8      //ç¼–ç æ ¼å¼ï¼Œé€šå¸¸éƒ½æ˜¯é€‰ `utf-8`Â 
trim_trailing_whitespace = false  //å»é™¤å¤šä½™çš„ç©ºæ ¼
insert_final_newline = false      //åœ¨å°¾éƒ¨æ’å…¥ä¸€è¡Œ
```

æ‰©å±•è£…å®Œï¼Œé…ç½®é…å®Œï¼Œç¼–è¾‘å™¨å°±ä¼šå»é¦–å…ˆè¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯¹ç¼©è¿›é£æ ¼ã€ç¼©è¿›å¤§å°åœ¨æ¢è¡Œæ—¶ç›´æ¥æŒ‰ç…§é…ç½®çš„æ¥ï¼Œåœ¨ä½ Â `ctrl+s`Â ä¿å­˜æ—¶ï¼Œå°±ä¼šæŒ‰ç…§é‡Œé¢çš„è§„åˆ™è¿›è¡Œä»£ç æ ¼å¼åŒ–ã€‚

### 2.Prettier

å¦‚æœè¯´Â `EditorConfig`Â å¸®ä½ ç»Ÿä¸€ç¼–è¾‘å™¨é£æ ¼ï¼Œé‚£Â `Prettier`Â å°±æ˜¯å¸®ä½ ç»Ÿä¸€é¡¹ç›®é£æ ¼çš„ã€‚

ä¸‹é¢æ˜¯æˆ‘å¸¸ç”¨çš„é…ç½®ï¼Œåœ¨æ ¹ç›®å½•ä¸‹æŸ¥åˆ›å»º`.prettierrc`

```js
{
  "arrowParens": "always",                //ç®­å¤´å‡½æ•°çš„å‚æ•°æ— è®ºæœ‰å‡ ä¸ªï¼Œéƒ½è¦æ‹¬å·åŒ…è£¹
  "bracketSameLine": false,              
  "bracketSpacing": true,                 //åœ¨å¯¹è±¡ä¸­çš„æ‹¬å·ä¹‹é—´æ‰“å°ç©ºæ ¼`{x: 1}`Â æ ¼å¼åŒ–ä¸º `{ x: 1 }`
  "embeddedLanguageFormatting": "auto",
  "htmlWhitespaceSensitivity": "css",
  "insertPragma": false,
  "jsxSingleQuote": false,               //jsx è¯­æ³•æ˜¯å¦å•å¼•å·
  "printWidth": 80,                      //å•è¡Œä»£ç æœ€é•¿å­—ç¬¦é•¿åº¦ï¼Œè¶…è¿‡ä¹‹åä¼šè‡ªåŠ¨æ ¼å¼åŒ–æ¢è¡Œã€‚
  "proseWrap": "preserve",
  "quoteProps": "as-needed",
  "requirePragma": false,
  "semi": true,                         //åˆ†å·æ˜¯å¦æ·»åŠ 
  "singleAttributePerLine": false,
  "singleQuote": true,                  //æ˜¯å¦å•å¼•å·
  "tabWidth": 2,
  "trailingComma": "none",              //å¯¹è±¡çš„æœ€åä¸€ä¸ªå±æ€§æœ«å°¾æ˜¯å¦æ·»åŠ  `,`
  "useTabs": true,
  "vueIndentScriptAndStyle": false,
  "endOfLine": "lf"                     //ä¸ `.editorconfig`Â ä¿æŒä¸€è‡´è®¾ç½®ã€‚
}
```

`.editorconfig`Â é…ç½®æ–‡ä»¶ä¸­æŸäº›é…ç½®é¡¹æ˜¯ä¼šå’Œ `Prettier`Â é‡åˆçš„ï¼Œä¾‹å¦‚ æŒ‡å®šç¼©è¿›å¤§å° ä¸¤è€…éƒ½å¯ä»¥é…ç½®ã€‚é‚£ä¹ˆä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ

`EditorConfig`Â çš„é…ç½®é¡¹éƒ½æ˜¯ä¸€äº›ä¸æ¶‰åŠå…·ä½“è¯­æ³•çš„ï¼Œæ¯”å¦‚ ç¼©è¿›å¤§å°ã€æ–‡ç§»é™¤å¤šä½™ç©ºæ ¼ç­‰ã€‚

è€Œ `Prettier`Â æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å·¥å…·ï¼Œè¦æ ¹æ®å…·ä½“è¯­æ³•æ ¼å¼åŒ–ï¼Œå¯¹äºä¸åŒçš„è¯­æ³•ç”¨å•å¼•å·è¿˜æ˜¯åŒå¼•å·ï¼ŒåŠ ä¸åŠ åˆ†å·ï¼Œå“ªé‡Œæ¢è¡Œç­‰ï¼Œå½“ç„¶ï¼Œè‚¯å®šä¹Ÿæœ‰ç¼©è¿›å¤§å°ã€‚

### 3.Eslint

eslintæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜äº†ï¼Œè¿™é‡Œä¸è¿‡å¤šå±•ç¤ºï¼Œåªç»™å¤§å®¶çœ‹ä¸€ä¸‹æˆ‘å¸¸ç”¨çš„eslinté…ç½®ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º`.eslintrc`;

```js
{
  "env": {
    "browser": true,
    "es2021": true,
    "node": true,
    "es6": true
  },
  "extends": [
    "eslint:recommended",
    "plugin:react/recommended",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaFeatures": {
      "jsx": true
    },
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": [
    "react",
    "@typescript-eslint",
    "react-hooks",
    "simple-import-sort",
    "import",
    "prettier"
  ],
  "rules": {
    "prettier/prettier": [
      "error",
      {},
      {
        "usePrettierrc": false
      }
    ],
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn",
    "@typescript-eslint/explicit-module-boundary-types": "off",
    "@typescript-eslint/no-var-requires": 0,
    "import/first": "error",
    "import/newline-after-import": "error",
    "import/no-duplicates": "error",
    "react/prop-types": "off",
    "simple-import-sort/exports": "error",
    "simple-import-sort/imports": [
      "error",
      {
        "groups": [
          [
            "^\\u0000"
          ],
          [
            "^react$",
            "^@?\\w"
          ],
          [
            "^[^.]"
          ],
          [
            // ../whatever/
            "^\\.\\./(?=.*/)",
            // ../
            "^\\.\\./",
            // ./whatever/
            "^\\./(?=.*/)",
            // Anything that starts with a dot
            "^\\.",
            // .html are not side effect imports
            "^.+\\.html$"
          ],
          [
            "^(./|../).*.s?css$"
          ]
        ]
      }
    ]
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}
```

åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯`eslint`å’Œ`prettier`åŒæ—¶é…ç½®åï¼Œå¯èƒ½ä¼šäº§ç”Ÿå†²çªã€‚æˆ‘ä»¬éœ€è¦æ›´æ–°ä¸€ä¸‹eslintçš„é…ç½®ï¼Œè§£å†³å†²çª

```shell
pnpm add eslint-config-prettier --save-dev
```

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df1409b834d840c2af8f729972e0899a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

## Git è§„èŒƒ

git è§„èŒƒåœ¨å›¢é˜Ÿåä½œæ—¶ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ git è§„èŒƒï¼Œåœ¨ç‰ˆæœ¬å‡ºç°é—®é¢˜æ—¶å¯ä»¥æ¸…æ™°çš„å®šä½

### git-cz

é¦–å…ˆï¼Œæˆ‘ä½¿ç”¨äº† `git-cz` è¿™ä¸ªåº“æ¥è¿›è¡Œè§„èŒƒåŒ–æäº¤

```js
pnpm add --save-dev git-cz
```

å®‰è£…å®Œæˆåï¼Œåœ¨ package.json é…ç½®æäº¤å‘½ä»¤

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66da6a2866c64ed3982ee076d5373e19~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

éšååœ¨éœ€è¦æäº¤æ—¶ï¼Œæ‰§è¡Œ

```shell
pnpm start
```

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/70826f2a05574b3ba0bb99e51dbc917c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

### husky + Git hooks é…ç½®æäº¤æ ¡éªŒ

åœ¨å‰é¢çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°ä½¿ç”¨ `git cz` è°ƒå‡ºè§„èŒƒé€‰é¡¹ï¼Œè¿›è¡Œè§„èŒƒçš„ message çš„ç¼–è¾‘ï¼›

ä½†æ˜¯å¦‚æœæˆ‘ä»¬å¿˜è®°ä½¿ç”¨ `git cz`, ç›´æ¥ä½¿ç”¨äº† `git commit -m "commit message"`, message ä¿¡æ¯ä¾ç„¶ä¼šè¢«æäº¤ä¸Šå»ï¼Œé¡¹ç›®ä¸­ä¼šå‡ºç°ä¸è§„èŒƒçš„æäº¤ message

å› æ­¤æˆ‘ä»¬éœ€è¦ husky + commit-msg + commitlint æ ¡éªŒæˆ‘ä»¬çš„æäº¤ä¿¡æ¯æ˜¯å¦è§„èŒƒã€‚

**å®‰è£…é…ç½® commitlint**

1. å®‰è£…ä¾èµ–

```shell
pnpm add --save-dev @commitlint/config-conventional @commitlint/cli
```

2. åˆ›å»ºÂ `commitlint.config.js`Â æ–‡ä»¶

```js
module.exports = {
  extends: ["@commitlint/config-conventional"],
  // å®šä¹‰è§„åˆ™ç±»å‹
  rules: {
    // type ç±»å‹å®šä¹‰ï¼Œè¡¨ç¤º git æäº¤çš„ type å¿…é¡»åœ¨ä»¥ä¸‹ç±»å‹èŒƒå›´å†…
    "type-enum": [
      2,
      "always",
      [
        "feat", // æ–°åŠŸèƒ½
        "fix", //  ä¿®å¤
        "docs", // æ–‡æ¡£å˜æ›´
        "style", // ä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œçš„å˜åŠ¨ï¼‰
        "refactor", // é‡æ„ï¼ˆæ—¢ä¸æ˜¯å¢åŠ featureï¼‰,ä¹Ÿä¸æ˜¯ä¿®å¤bug
        "pref", // æ€§èƒ½ä¼˜åŒ–
        "test", // å¢åŠ æµ‹è¯•
        "chore", // æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨
        "revert", // å›é€€
        "build", // æ‰“åŒ…
      ],
    ],
    // subject å¤§å°å†™ä¸åšæ ¡éªŒ
    "subject-case": [0],
  },
};
```

**å®‰è£…é…ç½®husky**

1. å®‰è£…ä¾èµ–Â 

```shell
pnpm add husky --save-dev
```

2. å¯åŠ¨ hooks, ç”Ÿæˆ .husky æ–‡ä»¶å¤¹Â 

```shell
npx husky install
```

3. åœ¨ package.json ä¸­ç”Ÿæˆ prepare æŒ‡ä»¤Â 

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/374a3f45ccd042bd8a9696bfef4522f4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

4. æ·»åŠ  commitlint çš„ hook åˆ° husky ä¸­ï¼Œ`commit-msg` æ—¶è¿›è¡Œæ ¡éªŒ

`npx husky add .husky/commit-msg 'npx --no-install commitlint --edit "$1"'`

æ·»åŠ å®Œæˆåï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72fb240f623c49dfb0a8e824013b619d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

5. æ­¤æ—¶ï¼Œä¸ç¬¦åˆè§„èŒƒçš„ commit å°†ä¸ä¼šè¢«å…è®¸æäº¤

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a396c9619bd64a1da5c749e4275ebdae~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

**pre-commit æ£€éªŒå½“å‰ä»£ç æ˜¯å¦æœ‰ ESLint é”™è¯¯**

åˆšæ‰æˆ‘ä»¬é…ç½®äº†åœ¨æäº¤æ—¶å¦‚æœæäº¤çš„ä¿¡æ¯ä¸ç¬¦åˆè§„èŒƒï¼Œæ˜¯ä¸å…è®¸è¢«æäº¤çš„ä½†å…¶å®åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å¯ä»¥åœ¨æäº¤ä»£ç æ—¶å¸®æˆ‘ä»¬è¿›è¡Œ `Eslint` æ£€æŸ¥

1. æ·»åŠ  commit æ—¶çš„ hookï¼Œ`pre-commit` æ—¶è¿è¡Œ npx lint-staged

`npx husky add .husky/pre-commit "npx lint-staged"`

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2556653a57ba40f19affcac74fcbad1f~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

è¿™ä¸ª `npx lint-staged` æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

`lint-staged`Â å¯ä»¥è®©ä½ å½“å‰çš„ä»£ç æ£€æŸ¥**åªæ£€æŸ¥æœ¬æ¬¡ä¿®æ”¹æ›´æ–°çš„ä»£ç ï¼Œå¹¶åœ¨å‡ºç°é”™è¯¯çš„æ—¶å€™ï¼Œè‡ªåŠ¨ä¿®å¤å¹¶æ¨é€**

ä¿®æ”¹Â `package.json`Â é…ç½®ï¼Œåœ¨æäº¤æ—¶å¸®æˆ‘ä»¬ prettier å’Œ eslint

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a97c0c177dab425e97d57571451297c7~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

å¦‚ä¸Šé…ç½®ï¼Œæ¯æ¬¡åœ¨ä½ æœ¬åœ° commit ä¹‹å‰ï¼Œæ ¡éªŒä½ æ‰€æçš„å†…å®¹æ˜¯å¦ç¬¦åˆä½ æœ¬åœ°é…ç½®çš„ eslint è§„åˆ™

- ç¬¦åˆè§„åˆ™ï¼Œæäº¤æˆåŠŸ
- ä¸ç¬¦åˆè§„åˆ™ï¼Œä»–ä¼šè‡ªåŠ¨æ‰§è¡Œ `eslint --cache --fix` å°è¯•å¸®ä½ è‡ªåŠ¨ä¿®å¤,ä¿®å¤æˆåŠŸï¼Œåˆ™ä¼šè‡ªåŠ¨å¸®ä½ æŠŠä¿®å¤å¥½çš„ä»£ç æäº¤ï¼›ä¿®å¤å¤±è´¥ï¼Œæç¤ºä½ é”™è¯¯ï¼Œè®©ä½ ä¿®å¤å¥½æ‰å¯ä»¥æäº¤ä»£ç ï¼›

## Vitestæµ‹è¯•

è¿™ä¸ªæ—¶å€™ï¼Œä½ å°±å¯ä»¥ç¼–å†™æµ‹è¯•ä»£ç äº†ï¼Œç„¶ååœ¨åç»­ CI/CD æ—¶å¯ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œç”±äºè¿™æ–¹é¢è‡ªå·±è¿˜ä¸å¤ªç†Ÿç»ƒï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šå±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¯•è¯•

## **æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²** CI/CD

æœ€ç»ˆçš„æ•ˆæœæ˜¯åŸºäºGithub Actionsåœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ï¼Œæ‰§è¡Œæ‰“åŒ…æ“ä½œï¼Œä»¥åŠéƒ¨ç½²åˆ°dockerï¼Œæœ€ååœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå®æ—¶æ›´æ–°

å¦‚æœä½ æƒ³å®ç°è¿™æ ·çš„æ•ˆæœå°±æ¥ç€å¾€ä¸‹çœ‹å§

### é…ç½®github Actions

#### é…ç½®CI Workflow

åœ¨é¡¹ç›®æ ¹ç›®å½•é‡Œçš„`.github/workflows`æ–‡ä»¶å¤¹ä¸Šæ–°å»º`ci.yml`ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
name: CI
# Eventè®¾ç½®ä¸ºmainåˆ†æ”¯çš„pull requestäº‹ä»¶ï¼Œ
# è¿™é‡Œçš„mainåˆ†æ”¯ç›¸å½“äºmasteråˆ†æ”¯ï¼Œgithubé¡¹ç›®æ–°å»ºæ˜¯æŠŠmainè®¾ç½®ä¸ºé»˜è®¤åˆ†æ”¯ï¼Œæˆ‘æ‡’å¾—æ”¹äº†æ‰€ä»¥å°±ä¿æŒè¿™æ ·å§
on:
  pull_request:
    branches: master
jobs:
  # åªéœ€è¦å®šä¹‰ä¸€ä¸ªjobå¹¶å‘½åä¸ºCI
  CI:
    runs-on: ubuntu-latest
    steps:
      # æ‹‰å–é¡¹ç›®ä»£ç 
      # æ­¤å¤„ actions/checkout æ“ä½œæ˜¯ä»ä»“åº“æ‹‰å–ä»£ç åˆ°Runneré‡Œçš„æ“ä½œ
      - name: Checkout repository
        uses: actions/checkout@v2
      # ç»™å½“å‰ç¯å¢ƒä¸‹è½½node
      # actions/setup-node@v3 æ“ä½œæ¥å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Node.jsï¼Œæ­¤å¤„æŒ‡å®šå®‰è£…çš„ç‰ˆæœ¬ä¸ºv16
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16.x"
      # æ£€æŸ¥ç¼“å­˜
      # å¦‚æœkeyå‘½ä¸­ç¼“å­˜åˆ™ç›´æ¥å°†ç¼“å­˜çš„æ–‡ä»¶è¿˜åŸåˆ° path ç›®å½•ï¼Œä»è€Œå‡å°‘æµæ°´çº¿è¿è¡Œæ—¶é—´
      # è‹¥ key æ²¡å‘½ä¸­ç¼“å­˜æ—¶ï¼Œåœ¨å½“å‰JobæˆåŠŸå®Œæˆæ—¶å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°ç¼“å­˜
      - name: Cache
        # ç¼“å­˜å‘½ä¸­ç»“æœä¼šå­˜å‚¨åœ¨steps.[id].outputs.cache-hité‡Œï¼Œè¯¥å˜é‡åœ¨ç»§åçš„stepä¸­å¯è¯»
        id: cache-dependencies
        uses: actions/cache@v3
        with:
          # ç¼“å­˜æ–‡ä»¶ç›®å½•çš„è·¯å¾„
          path: |
            **/node_modules
          # keyä¸­å®šä¹‰ç¼“å­˜æ ‡å¿—ä½çš„ç”Ÿæˆæ–¹å¼ã€‚runner.OSæŒ‡å½“å‰ç¯å¢ƒçš„ç³»ç»Ÿã€‚å¤–åŠ å¯¹yarn.lockå†…å®¹ç”Ÿæˆå“ˆå¸Œç ä½œä¸ºkeyå€¼ï¼Œå¦‚æœyarn.lockæ”¹å˜åˆ™ä»£è¡¨ä¾èµ–æœ‰å˜åŒ–ã€‚
          # è¿™é‡Œç”¨yarn.lockè€Œä¸æ˜¯package.jsonæ˜¯å› ä¸ºpackage.jsonä¸­è¿˜æœ‰versionå’Œdescriptionä¹‹ç±»çš„æè¿°é¡¹ç›®ä½†å’Œä¾èµ–æ— å…³çš„å±æ€§
          key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
      # å®‰è£…ä¾èµ–
      - name: Installing Dependencies
        # å¦‚æœç¼“å­˜æ ‡å¿—ä½æ²¡å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œè¯¥stepã€‚å¦åˆ™å°±è·³è¿‡è¯¥step
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: yarn install
      # è¿è¡Œä»£ç æ‰«æ
      - name: Running Lint
        # é€šè¿‡å‰é¢ç« èŠ‚å®šä¹‰çš„å‘½ä»¤è¡Œæ‰§è¡Œä»£ç æ‰«æ
        run: yarn lint

      - name: build project
        run: yarn build
```

è¿™æ—¶ï¼Œæˆ‘ä»¬åœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶ä¼šæ‰§è¡Œè¿™ä¸ª yml æ–‡ä»¶ï¼Œç„¶åå°±ä¼šå‡ºç°ä¸‹é¢çš„æ ·å­ï¼Œè¯´æ˜ä½ ç¼–å†™çš„æµæ°´çº¿æ­£åœ¨æ‰§è¡Œäº†

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ac6a325ec614eb8b024aaa4aeac521a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ç°åœ¨æˆ‘ä»¬åªæ˜¯åœ¨æ¯æ¬¡åˆå¹¶çš„æ—¶å€™è¿›è¡Œäº†æ‰“åŒ…ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰è¿›è¡ŒæŒç»­çš„éƒ¨ç½²ã€‚

æˆ‘æƒ³è¦çš„æ•ˆæœæ˜¯æˆ‘åªè¦åˆå¹¶åœ¨äº†ä¸»åˆ†æ”¯ä¸Šï¼Œæˆ‘çš„æœåŠ¡å™¨ä¸Šçš„å†…å®¹èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°ã€‚

æˆ‘é‡‡å–äº†é€šè¿‡ docker æ„å»ºé•œåƒï¼Œå‘å¸ƒåˆ° Docker Hub ä¸Šï¼Œæœ€åæˆ‘é€šè¿‡è¿œç¨‹ç™»å½•æœåŠ¡å™¨ï¼Œæ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼Œä»è€Œå®æ—¶æ›´æ–°ã€‚

### Docker

é¦–å…ˆæˆ‘ä»¬å…ˆå®‰è£…ä¸€ä¸‹ docker

```js
brew cask install docker
```

æŸ¥çœ‹ç‰ˆæœ¬

```js
docker -v
```

**æ‹‰å– Nginx é•œåƒ**

é¦–å…ˆæ‰“å¼€ä½ çš„ Docker ï¼Œé»˜è®¤ä¼šå¯åŠ¨ã€‚

æ§åˆ¶å°æ‹‰å– Nginx é•œåƒï¼š

```js
docker pull nginx
```

1.åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º`nginx.conf`

```shell
user  nginx;
worker_processes  auto;
 
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
 
 
events {
    worker_connections  1024;
}
 
 
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
 
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
 
    access_log  /var/log/nginx/access.log  main;
 
    sendfile        on;
    #tcp_nopush     on;
 
    keepalive_timeout  65;
 
    #gzip  on;
 
	server {
		listen       80;
		listen  [::]:80;
		server_name  localhost;
		location / {
			root   /etc/nginx/html;
			index  index.html index.htm;
		}
		location = /50x.html {
			root   /usr/share/nginx/html;
		}
		
	}
}
```

2. åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º `Dockerfile`

```shell
# è®¾ç½®åŸºç¡€é•œåƒ 
FROM daocloud.io/library/nginx:1.9.1
# å®šä¹‰ä½œè€…
MAINTAINER jiaynn
# æ·»åŠ æ—¶åŒºç¯å¢ƒå˜é‡ï¼Œäºšæ´²ï¼Œä¸Šæµ·
ENV TimeZone=Asia/Shanghai
# å°†distæ–‡ä»¶ä¸­çš„å†…å®¹å¤åˆ¶åˆ° /etc/nginx/html/ è¿™ä¸ªç›®å½•ä¸‹é¢
COPY dist/  /etc/nginx/html/
# å°†é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹å¤åˆ¶åˆ° /etc/nginx è¿™ä¸ªç›®å½•ä¸‹é¢(å¢åŠ è‡ªå·±çš„ä»£ç†åŠä¸€äº›é…ç½®)
RUN rm -rf /etc/nginx/nginx.conf 
# ç”¨æœ¬åœ°çš„nginxé…ç½®æ–‡ä»¶è¦†ç›–é•œåƒçš„Nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf
# æš´éœ²ç«¯å£
EXPOSE 80
```

3. é…ç½® CD æµæ°´çº¿ ç›´æ¥æŠŠå®ƒè¡¥å……åˆ° `.github/workflows` æ–‡ä»¶å¤¹ä¸Šçš„ `ci.yml` ä¸­

âš ï¸æ³¨æ„ï¼Œåœ¨ç¼–å†™**CD Workflow**å‰ï¼Œæˆ‘ä»¬è¦å‡†å¤‡ä»¥ä¸‹ä¸œè¥¿ï¼š

1. å†…ç½® `nginx` çš„æœåŠ¡å™¨ä¸€å°ï¼šç”¨äºéƒ¨ç½²åˆ¶å“
2. æœåŠ¡å™¨çš„è´¦å·å’Œå¯†ç 
3. Docker Hub çš„è´¦å·å’Œå¯†ç 
4. Docker Hub çš„è¿œç¨‹ä»“åº“

æŠŠæ­¥éª¤ 2 å’Œæ­¥éª¤ 3 åŠå…¶ä»–å…³äºæœºå™¨çš„ä¿¡æ¯éƒ½æ”¾åœ¨å¯¹åº”ä»“åº“çš„**Secret**é‡Œï¼Œå¯¹åº”å…¶ä¸­çš„è´¦å·å¯†ç ï¼Œä½ å¯ä»¥æä¾›å¯†é’¥å¯¹,é€šè¿‡ ssh å…å¯†ç™»å½•è¿›è¡Œéƒ¨ç½²,è¿™é‡Œæˆ‘ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥ä½¿ç”¨è´¦å·å¯†ç ç™»å½•

å…·ä½“æµç¨‹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0197ad7b7ec4a969d5d3102379d26e5~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de14f5a551934efe81f33e3b2ff967a2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

ä¸æ­¤åŒæ—¶ï¼Œæˆ‘è¿˜é…ç½®äº†ä¸€äº›å˜é‡åœ¨ä¸Šé¢

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad1ec1235ce84c8ca8bfad80c78e5222~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

è¯¦ç»†çš„è§£é‡Šå†™åœ¨äº†æ³¨é‡Šé‡Œé¢

```shell
- name: æ‰“åŒ…é•œåƒ, ä¸Šä¼  Docker Hub
    run: |
    # ç™»å½•docker, secrets.DOCKER_USERNMAE å°±æ˜¯æˆ‘ä»¬åœ¨githubä¸Šé…ç½®çš„dockerçš„è´¦æˆ·å’Œå¯†ç 
        docker login -u ${{secrets.DOCKER_USERNAME }} -p  ${{ secrets.DOCKER_PASSWORD }}
    # æ‰“åŒ…é•œåƒ -tå‚æ•°ç»™é•œåƒå‘½å 
    # .æ˜¯åŸºäºå½“å‰ç›®å½•çš„ Dockerfile æ¥æ„å»ºé•œåƒ
        docker build --platform linux/amd64 -t ${{ vars.USER_NAME }}/${{ vars.IMAGE_NAME }}:latest  .
    # æ¨é€åˆ°æˆ‘ä»¬çš„ docker é•œåƒä»“åº“
        docker push ${{ secrets.DOCKER_REPOSITORY }}

- name: ç™»å½•æœåŠ¡å™¨, æ‰§è¡Œè„šæœ¬
    uses: appleboy/ssh-action@master
    with:
        host: ${{ secrets.REMOTE_HOST }}
        username: root
        password: ${{ secrets.REMOTE_PASSWORD }}
        # æ‰§è¡Œè„šæœ¬
        script: |
        # éƒ¨ç½²è„šæœ¬ åé¢çš„varsæ˜¯ä¼ é€’ç»™è„šæœ¬çš„å‚æ•°
        deploy.sh ${{ vars.USER_NAME }} ${{ vars.IMAGE_NAME }} ${{ vars.PORT }} ${{ vars.CONTAINS_PORT }}
```

**deploy.sh**

éœ€è¦å°†è¿™ä¸ªæ–‡ä»¶å†™åœ¨ä½ çš„æœåŠ¡å™¨ä¸Šï¼Œå› ä¸ºæ˜¯ä½ çš„æµæ°´çº¿ç™»å½•åˆ°ä½ çš„æœåŠ¡å™¨ä¸Šåæ‰§è¡Œçš„è„šæœ¬ è¿œç¨‹ç™»å½•æœåŠ¡å™¨ï¼Œåˆ›å»º script æ–‡ä»¶å¤¹ï¼Œä»¥åŠåˆ›å»º deploy.sh æ–‡ä»¶

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d20e9dda0574904881cd072890f11c7~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)

```shell
# è¿™é‡Œçš„$1ã€$2å¯¹åº”ä¸Šé¢ä¼ é€’è¿‡æ¥çš„å‚æ•°
user_name=$1
image_name=$2
PORT=$3
CONTAINS_PORT=$4
# å¦‚æœä¼ å…¥çš„å‚æ•°æœ‰ä¸€ä¸ªä¸ºç©ºï¼Œæˆ‘ä»¬å°±æç¤ºä»–è¾“å…¥å‚æ•°ï¼Œç„¶åé€€å‡º
if [ "$1" == "" ]  || [ "$2" == "" ] || [ "$3" == "" ] || [ "$4" == ""]; then 
  echo "è¯·è¾“å…¥å‚æ•°"
  exit
fi

# åˆ é™¤å®¹å™¨,å°±æ˜¯åˆ é™¤æ—§çš„å®¹å™¨
# docker ps -a è·å–æ‰€æœ‰çš„å®¹å™¨
# ï½œ grep ${image_name} å¾—åˆ°è¿™ä¸ªå®¹å™¨ awk '${print $1}' æ ¹æ®ç©ºæ ¼åˆ†å‰²ï¼Œè¾“å‡ºç¬¬ä¸€é¡¹
containerId=`docker ps -a | grep ${image_name} | awk '{print $1}'`
if [ "$containerId" != "" ] ; then
# åœæ­¢è¿è¡Œ
docker stop $containerId
# åˆ é™¤å®¹å™¨
docker rm $containerId
echo "Delete Container Success"
fi

# åˆ é™¤é•œåƒ
# è·å–æ‰€æœ‰çš„é•œåƒï¼Œå¾—åˆ°æˆ‘ä»¬è‡ªå·±æ„å»ºçš„é•œåƒçš„id
imageId=`docker images | grep ${user_name}/${image_name} | awk '{print $3}'`
if [ "$imageId" != "" ] ; then
# åˆ é™¤é•œåƒ
docker rmi -f $imageId
echo "Delete Image Success"
fi
# ç™»å½•docker
docker login -u lijiayan -p ä½ åœ¨docker hubä¸Šè·å–çš„å¯†é’¥
# æ‹‰å–dockerä¸Šæ–°çš„é•œåƒ
docker pull ${user_name}/${image_name}:latest
# è¿è¡Œæœ€æ–°çš„é•œåƒ 
# -d è®¾ç½®å®¹å™¨åœ¨åå°è¿è¡Œ
# -p è¡¨ç¤ºç«¯å£æ˜ å°„ï¼ŒæŠŠæœ¬æœºçš„ 92 ç«¯å£æ˜ å°„åˆ° container çš„ 80 ç«¯å£ï¼ˆè¿™æ ·å¤–ç½‘å°±èƒ½é€šè¿‡æœ¬æœºçš„ 92 ç«¯å£è®¿é—®äº†
# å¦‚æœæœåŠ¡å™¨é‡å¯åï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å¯åŠ¨docker
# æ‰§è¡Œ systemctl restart docker é‡æ–°å¯åŠ¨docker
# ä½†dockerå¯åŠ¨äº†ï¼Œé‡Œé¢çš„å®¹å™¨æ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ --restart=always ï¼Œdockerå¯åŠ¨åï¼Œå®¹å™¨ä¹Ÿå¯ä»¥å¯åŠ¨
# dokcer ps -a æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨
docker run -d -p $3:$4 --name $image_name --restart=always ${user_name}/${image_name}:latest
echo "Start Container Successs"
echo "$image_name"

```

è¿™æ˜¯æ­£åœ¨è·‘æˆ‘ä»¬çš„æµæ°´çº¿ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3dea2db2bca46d194e1fccc324e61c4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?) è¿™æ ·æœ€æ–°çš„éƒ¨ç½²å°±æˆåŠŸå•¦

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbba16c1a82040bd87c387ab3f637bce~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)
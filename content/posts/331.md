---
title: "React Context å®Œç¾æ›¿ä»£å“ Jotai"
date: 2023-01-14T09:47:33+08:00
---

## 1. å‰è¨€

React çš„å±æ€§é€ä¼ åœºæ™¯ è™½ç„¶æœ‰å¾ˆå¤šæ–¹å¼å¯ä»¥å®ç°ï¼Œä½†èƒ½åšåˆ°ä»£ç å†™çš„å°‘ã€re-render è½»æ¾å¤„ç†çš„æ–¹å¼å¹¶ä¸å¤šã€‚

è€ŒçŠ¶æ€ç®¡ç†å·¥å…· [Jotai](https://github.com/pmndrs/jotai) å´å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™äº›é—®é¢˜ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e19c10b463cf46789bcd128ec713f2e6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

æœ€è¿‘çš„ä¸šåŠ¡å’Œç»„ä»¶åœºæ™¯é‡Œ ä¹Ÿåœ¨ç”¨æ­¤æ–¹å¼å®ç°ã€‚

## 2. React Context çš„ä¸è¶³

å¸¸è§„è§£å†³æ•°æ®é€ä¼ é€šå¸¸ä½¿ç”¨ React çš„ Context æ¥å®ç°ï¼Œä½†å®ƒå´æœ‰ä¸€äº›ä¸è¶³çš„åœ°æ–¹ï¼š

- React Context.Provider åµŒå¥—åœ°ç‹±é—®é¢˜ã€‚
- Context value ä¿®æ”¹æ—¶ï¼Œè§¦å‘æ¶ˆè´¹ Context ç»„ä»¶ re-render çš„é—®é¢˜ï¼ˆç»„ä»¶å¼•ç”¨å€¼æœªå˜åŒ–æ—¶ï¼‰ã€‚

### 2.1 Provider åµŒå¥—åœ°ç‹±

å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```jsx
<Context1.Provider value={value1}>
  <Context2.Provider value={value2}>
    <Context3.Provider value={value3}>
      <Context4.Provider value={value4}>
        <Context5.Provider value={value5}>
          <Context6.Provider value={value6}>{children}</Context6.Provider>
        </Context5.Provider>
      </Context4.Provider>
    </Context3.Provider>
  </Context2.Provider>
</Context1.Provider>
```

### 2.2 Context re-render

æ­¤é—®é¢˜é€šå¸¸æœ‰ä¸‰ç§æ–¹å¼æ¥è§£å†³ï¼š

1. å°†åŒ…å«å¤šä¸ªå±æ€§çš„ Context å‰¥ç¦»æˆå•ä¸ª Context è¿›è¡Œä½¿ç”¨ã€‚ä½†è¿™æ ·ä¼šå¯¼è‡´ 2.1 ä¸­åµŒå¥—åœ°ç‹±çš„é—®é¢˜å‘ç”Ÿã€‚

```jsx
function Button() {
  let theme = useContext(ThemeContext);
  return <ExpensiveTree className={theme} />;
}
```

2. å°†ç»„ä»¶å‰¥ç¦»æˆä¸¤ä¸ªï¼Œå‰¥ç¦»å‡ºæ¥çš„ç”¨ `React.memo` è¿›è¡ŒåŒ…è£¹ï¼Œå†æ¶ˆè´¹ã€‚

```jsx
function Button() {
  let appContextValue = useContext(AppContext);
  let theme = appContextValue.theme;
  return <ThemedButton theme={theme} />;
}

const ThemedButton = memo(({ theme }) => {
  return <ExpensiveTree className={theme} />;
});
```

3. åœ¨ç»„ä»¶çš„ return ä¸­ï¼Œç”¨ `React.useMemo` åŒ…è£¹ï¼Œå°† Context ä¸­æ¶ˆè´¹çš„å€¼ï¼Œåšä¸ºå…¶ä¾èµ–é¡¹ã€‚

```jsx
function Button() {
  let appContextValue = useContext(AppContext);
  let theme = appContextValue.theme;

  return useMemo(() => {
    return <ExpensiveTree className={theme} />;
  }, [theme]);
}
```

ä½†è¿™äº›æ–¹æ³•ï¼Œéƒ½ä¼šåœ¨ä½¿ç”¨æ—¶å¢åŠ ä¸€äº›é¢å¤–çš„å·¥ä½œé‡ï¼Œå˜å¾—ç¹çå’Œæ˜“å‡ºé”™ã€‚

## 3. çŠ¶æ€ç®¡ç†åº“ Jotai çš„ä¼˜åŠ¿

åˆšå¥½ Jotai çš„å…¶ä¸­ä¸€éƒ¨åˆ†ä¼˜åŠ¿å°±èƒ½è§£å†³ React Context ä¸­çš„è¿™äº›é—®é¢˜ã€‚

Jotai å¯ä»¥å®Œç¾çš„è§£å†³åµŒå¥—åœ°ç‹±çš„é—®é¢˜ï¼ŒåŠç²¾å‡† re-render çš„é—®é¢˜ã€‚

ç®€å•å†™äº†ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹ä¸€ä¸‹ Jotai re-renderï¼š[\[codesandbox\] jotai é…åˆ React.memo re-render æµ‹è¯•](https://codesandbox.io/s/jotai-accurate-render-react-memo-c54ot5)ã€‚

ä¾‹å­ä¸­ Jotai çš„ Atom åŠç»„ä»¶æ¶ˆè´¹å…³ç³»å¦‚ä¸‹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2238f33216c4c10bf4aa432e70632ec~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

## 4. Jotai æ ¸å¿ƒ

Jotai çš„å­¦ä¹ æˆæœ¬å¾ˆä½ï¼Œæºç ä¹Ÿæ¯”è¾ƒæ˜“è¯»ã€‚æ ¸å¿ƒå°±ä¸‰ä¸ª APIï¼š

- atomï¼šåˆ›å»ºåŸå­ç›¸å…³æ–¹æ³•ã€‚
- useAtomï¼šè§†å›¾å…³è”åŸå­ç›¸å…³æ–¹æ³•ã€‚
- Providerï¼šéš”ç¦»å’Œå­˜å‚¨åŸå­å®ä¾‹ç›¸å…³ç»„ä»¶ã€‚

åªéœ€è¦ç†Ÿæ‚‰è¿™ä¸‰ä¸ª API çš„ä½¿ç”¨å°±å¯ä»¥è½»æ¾ä¸Šæ‰‹ã€‚

### 4.1 atom

atom åˆ›å»ºçš„å…¶å®æ˜¯ä¸€ä»½åŸå­æè¿°ï¼Œå¹¶ä¸ä¼šè¿›è¡Œç›¸å…³çš„å­˜å‚¨ã€‚

å¯ä»¥åˆ›å»ºåŸå§‹åŸå­åŠæ´¾ç”ŸåŸå­ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š

```js
// primitive atom
function atom<Value>(initialValue: Value): PrimitiveAtom<Value>

// read-only atom
function atom<Value>(read: (get: Getter) => Value | Promise<Value>): Atom<Value>

// writable derived atom
function atom<Value, Update>(
  read: (get: Getter) => Value | Promise<Value>,
  write: (get: Getter, set: Setter, update: Update) => void | Promise<void>
): WritableAtom<Value, Update>

// write-only derived atom
function atom<Value, Update>(
  read: Value,
  write: (get: Getter, set: Setter, update: Update) => void | Promise<void>
): WritableAtom<Value, Update>


const primitiveAtom = atom(initialValue)
const derivedAtomWithRead = atom(read)
const derivedAtomWithReadWrite = atom(read, write)
const derivedAtomWithWriteOnly = atom(null, write)
```

### 4.2 useAtom

ç”¨æ¥å°† atom å…³è”åˆ°è§†å›¾ä¸­ï¼Œå½¢æˆå“åº”å…³ç³»ã€‚ï¼ˆatom å¿…é¡»ä¿æŒå¼•ç”¨ä¸å˜ï¼Œå¦åˆ™ä¼šæ— é™å¾ªç¯ï¼‰

åŸºæœ¬ç”¨æ³•ï¼š

```js
// primitive or writable derived atom
function useAtom<Value, Update>(
  atom: WritableAtom<Value, Update>,
  scope?: Scope
): [Value, SetAtom<Update>]

// read-only atom
function useAtom<Value>(atom: Atom<Value>, scope?: Scope): [Value, never]
```

å¦‚æœâ€œåªè¯»â€æˆ–â€œåªå†™â€ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ï¼š

- useAtomValue
- useSetAtom

### 4.3 Provider

ä½¿ç”¨ä¸Šå’Œ React Provider å¾ˆç›¸ä¼¼ï¼Œå½“ç„¶åº•å±‚ä¹Ÿæ˜¯ç”¨ React Context.Provider åŒ…è£…çš„ã€‚

ä¸»è¦ç”¨æ¥éš”ç¦» atom å®ä¾‹ åŠå­˜å‚¨ atom å®ä¾‹ç”¨çš„ã€‚

æœ‰éš”ç¦»éœ€æ±‚å¯ä»¥åŒ…è£¹åœ¨è§†å›¾ä¸­ï¼Œæ— éš”ç¦»éœ€æ±‚å¯ä»¥ä¸æ·»åŠ ï¼Œå’Œ React Context.Provider ä¸€æ ·ã€‚

åŸºæœ¬ç”¨æ³•ï¼š

```js
const Provider: React.FC<{
  initialValues?: Iterable<readonly [AnyAtom, unknown]>
  scope?: Scope
}>
```

## 5\. Jotai å®ç°åŸç†

ä¸‹é¢çœ‹ä¸€ä¸‹å†…éƒ¨å®ç°çš„åŸºæœ¬åŸç†ã€‚

### 5.1 Provider

Provider çš„åˆ›å»ºæºç ï¼š

```js
const ScopeContainerContext = getScopeContext(scope);

return createElement(
  ScopeContainerContext.Provider,
  {
    // åˆ›å»º atoms çš„ weakMap ç­‰å­˜å‚¨ï¼ŒæŒ‚è½½åœ¨ Provider ä¸­
    value: scopeContainerRef.current,
  },
  children
);
```

```js
const ScopeContextMap = new Map<Scope | undefined, ScopeContext>()

export const getScopeContext = (scope?: Scope) => {
  if (!ScopeContextMap.has(scope)) {
    ScopeContextMap.set(scope, createContext(createScopeContainer()))
  }

  return ScopeContextMap.get(scope) as ScopeContext
}
```

```js
const scopeContainerRef = useRef<ScopeContainer>()
// ä»æ­¤å¤„å¯ä»¥çœ‹åˆ°ï¼ŒProvider ä»…ä½œä¸ºéš”ç¦»æ•°æ®ä½¿ç”¨ï¼ŒåæœŸä¸ä¼šå‘ç”Ÿä»»ä½• value å±‚é¢çš„å˜åŒ–ï¼Œ
// æ‰€æœ‰çš„è§¦å‘ï¼Œéƒ½ç”± å†…éƒ¨çš„ æŸä¸ª atom çš„ listeners å»è°ƒç”¨æ¸²æŸ“
if (!scopeContainerRef.current) {
  // lazy initialization
  const scopeContainer = createScopeContainer(
    // initialValues ä»…ä½œç”¨ä¸€æ¬¡ï¼ŒåæœŸçš„ä»»ä½•å˜åŒ–ï¼Œå°†ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœ
    initialValues,
    unstable_createStore
  )
  if (unstable_enableVersionedWrite) {
    let retrying = 0
    scopeContainer.w = (write) => {
      setVersion((parentVersion) => {
        const nextVersion = retrying ? parentVersion : { p: parentVersion }
        write(nextVersion)
        return nextVersion
      })
    }
    scopeContainer.v = version
    scopeContainer.r = (fn) => {
      ++retrying
      fn()
      --retrying
    }
  }
  scopeContainerRef.current = scopeContainer
}
```

å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼Œä¸»è¦å°±åšäº†ï¼š

- Provider éš”ç¦»ã€‚
- åœ¨ Provider çš„ value ä¸­æŒ‚è½½ atom å®ä¾‹ã€‚
- é€šè¿‡ `scope` ç¼“å­˜ createContext å®ä¾‹ã€‚

å¦å¤–ï¼Œåˆ›å»ºå®Œ Provider åï¼Œæœªæ¥çš„æ‰€æœ‰å˜åŒ–éƒ½ä¸ä¼šå¯¼è‡´å…¶å†…éƒ¨çš„ value å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ç”± Provider å¯¼è‡´çš„æ¸²æŸ“æ˜¯ä¸å­˜åœ¨çš„ã€‚ä¸” `initialValues` ä¹Ÿåªä¼šæ¶ˆè´¹ä¸€æ¬¡ï¼Œæœªæ¥å˜åŒ–ä¹Ÿä¸ä¼šå“åº”ã€‚

> é€šè¿‡ `scope` çš„è®¾ç½®ï¼Œå¯ä»¥å®ç°å’ŒåŸç”Ÿ React Context.Provider ä¸€æ ·çš„æ•ˆæœï¼Œè¿›è¡Œåˆ†å‰²åŠå¤šå±‚åµŒå¥—ã€‚

### 5.2 atom

atom çš„ç”Ÿæˆå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä»½æè¿°ï¼š

```js
export function atom<Value, Args extends unknown[], Result>(
  read: Value | Read<Value, SetAtom<Args, Result>>,
  write?: Write<Args, Result>
) {
  const key = `atom${++keyCount}`
  const config = {
    toString: () => key,
  } as WritableAtom<Value, Args, Result> & { init?: Value }
  if (typeof read === 'function') {
    config.read = read as Read<Value, SetAtom<Args, Result>>
  } else {
    config.init = read
    config.read = (get) => get(config)
    config.write = ((get: Getter, set: Setter, arg: SetStateAction<Value>) =>
      set(
        config as unknown as PrimitiveAtom<Value>,
        typeof arg === 'function'
          ? (arg as (prev: Value) => Value)(get(config))
          : arg
      )) as unknown as Write<Args, Result>
  }
  if (write) {
    config.write = write
  }
  return config
}
```

ç”Ÿæˆå®Œæˆåï¼Œä¼šæŒ‚è½½åœ¨ Provider çš„ store ä¸­ã€‚store ç”± WeakMap ç»´æŠ¤ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚

store ä¸­çš„æ´¾ç”Ÿ atom çš„è§¦å‘å˜åŒ–å’Œæ¸²æŸ“ï¼Œä¸»è¦ç”± `dependencies` å’Œ `listeners` å®ç°ã€‚

### 5.3 useAtom

```js
export function useAtomValue<Value>(atom: Atom<Value>, scope?: Scope) {
  const ScopeContext = getScopeContext(scope);
  const scopeContainer = useContext(ScopeContext);
  // ...
}
```

å¯ä»¥çœ‹åˆ° useAtom ä¸­çš„ä¿¡æ¯ä¹Ÿæ˜¯é€šè¿‡è¯»å– Context å®ç°ï¼Œscope ç”¨æ¥æ ‡è¯†ä¸ Provider åŒ¹é…ã€‚

```js
const [[version, valueFromReducer, atomFromReducer], rerenderIfChanged] =
  useReducer<
    Reducer<
      readonly [VersionObject | undefined, Awaited<Value>, Atom<Value>],
      VersionObject | undefined
    >,
    VersionObject | undefined
  >(
    (prev, nextVersion) => {
      const nextValue = getAtomValue(nextVersion)
      if (Object.is(prev[1], nextValue) && prev[2] === atom) {
        return prev // bail out
      }
      return [nextVersion, nextValue, atom]
    },
    versionFromProvider,
    (initialVersion) => {
      const initialValue = getAtomValue(initialVersion)
      return [initialVersion, initialValue, atom]
    }
  )
```

åŸºäº useAtom åˆ›å»ºçš„å€¼ï¼Œç”± useReducer å®ç°ï¼Œå¯ä»¥æœ‰æ•ˆä¼˜åŒ–éƒ¨åˆ† re-render çš„é—®é¢˜ã€‚

```js
useEffect(() => {
  const { v: versionFromProvider } = scopeContainer;
  if (versionFromProvider) {
    store[COMMIT_ATOM](atom, versionFromProvider);
  }
  // Call `rerenderIfChanged` whenever this atom is invalidated. Note
  // that derived atoms may not be recomputed yet.
  const unsubscribe = store[SUBSCRIBE_ATOM](
    atom,
    rerenderIfChanged,
    versionFromProvider
  );
  rerenderIfChanged(versionFromProvider);
  return unsubscribe;
}, [store, atom, scopeContainer]);
```

```js
const subscribeAtom = (
  atom: AnyAtom,
  callback: (version?: VersionObject) => void,
  version?: VersionObject
) => {
  const mounted = addAtom(version, atom);
  const listeners = mounted.l;
  listeners.add(callback);
  return () => {
    listeners.delete(callback);
    // TODO should version be `undefined` for delAtom?
    delAtom(version, atom);
  };
};
```

useRender çš„ dispatch ä¼šæ·»åŠ åˆ° atom çš„è®¢é˜…åˆ—è¡¨ä¸­ï¼Œå½“ atom å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œè®¢é˜…åˆ—è¡¨ä¸­çš„ dispatch å®ç°å“åº”ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f8a7fa6402c47f6b26de1442fdfb22b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

## 6\. å¼€å‘ä¸­çš„æ³¨æ„

å¦‚æœ Jotai ä½¿ç”¨åœ¨åº”ç”¨çº§çš„å…¨å±€çŠ¶æ€ä¸­ï¼Œä¸å¤ªéœ€è¦æ³¨æ„ã€‚ä½†åœ¨å¼€å‘çš„ç»„ä»¶ä¸­ä½¿ç”¨ Jotai è¿˜æ˜¯éœ€è¦æ³¨æ„çš„ã€‚

### 6.1 å¼€å‘ç»„ä»¶çš„æ³¨æ„

æœ€æ ¹æœ¬çš„ä¸€ç‚¹å°±æ˜¯ atom çš„éš”ç¦»é—®é¢˜ï¼Œä¸ç„¶ç»„ä»¶å†…çš„æ•°æ®ç”¨çš„æ˜¯åŒä¸€ä»½ï¼Œä¼šå¯¼è‡´å¹²æ‰°ã€‚

æ‰€ä»¥éœ€è¦é¢å¤–åŒ…è£¹ Provider è¿›è¡Œéš”ç¦»ï¼š

```jsx
const ComponentA = () => {
  return <div>A</div>;
};

export default () => {
  return (
    <Provider>
      <ComponentA />
    </Provider>
  );
};
```

å¦‚æœåŸç»„ä»¶æœ‰ memoï¼Œéœ€è¦æŠŠå®ƒç§»åˆ° Provider è¿™ä¸€å±‚ï¼š

```jsx
export default memo(() => {
  return (
    <Provider>
      <ComponentA />
    </Provider>
  );
});
```

å¦‚æœæœ‰ forwardRef ä¹‹ç±»çš„ï¼ŒåŸºæœ¬è¦å†™ä¸¤éï¼š

```jsx
const ComponentA = forwardRef(({ onChange, defaultValue }, ref) => {
  useImperativeHandle(ref, () => ({ changeStyle }));
  return <div>A</div>;
});

export default memo(
  forwardRef((props, ref) => {
    useImperativeHandle(ref, () => ({
      changeStyle: _ref.current.changeStyle,
    }));

    const _ref = useRef();

    return (
      <Provider>
        <ComponentA ref={_ref} />
      </Provider>
    );
  })
);
```

---

> [ğŸŒŸ Github åŸæ–‡åœ°å€](https://github.com/lecepin/blog/blob/main/React%20Context%20%E5%AE%8C%E7%BE%8E%E6%9B%BF%E4%BB%A3%E5%93%81%20Jotai.md)

---
title: "ChatAudio å®ç°è¯­éŸ³å¯¹è¯ï¼ˆä½ä»¿å¾®ä¿¡èŠå¤©ï¼‰"
date: 2023-04-14T10:24:52+08:00
---

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/503fa32ac4084f6ea288659a1743fcb2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

## æ•ˆæœå›¾

| ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72fb5dc5c4594e1ea88474a711c0b47d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp) | ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43092a43ec1a4990a92c17b0d243a512~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp) | ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d787284bfcd346d39e8fea285635915b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp) |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |

## ä»€ä¹ˆæ˜¯ STT å’Œ TTSï¼Ÿ

- `STT` æ˜¯è¯­éŸ³è½¬æ–‡å­—ï¼ˆSpeech To Textï¼‰
- `TTS` æ˜¯æ–‡å­—è½¬è¯­éŸ³ï¼ˆText To Speechï¼‰

> ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ `SST` + `TTS` å¦‚æœç”¨æˆ·ç›´æ¥è¾“å…¥éŸ³é¢‘ï¼Œ`OpenAI` çš„ `API` ä¸­å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨è¯­éŸ³å’Œ `GPT` è¿›è¡Œå¯¹è¯çš„åŠŸèƒ½ã€‚

## æ‰€éœ€ä¾èµ–

- express
- express-fileupload
- openai
- websocket
- nodemon
- dotenv

## å®ç°è¯­éŸ³è½¬æ–‡å­—ï¼ˆSTTï¼‰

å‰é¢è¯´åˆ°äº†ï¼Œ`OpenAI` ä¸­ä¸å­˜åœ¨è¿™ç§ `API`ï¼Œä½†æ˜¯æä¾›äº†ä¸€ä¸ª `Whisper` æœºå™¨äººï¼Œæ”¯æŒå°†éŸ³é¢‘æµè½¬åŒ–ä¸ºæ–‡æœ¬ï¼Œä¹Ÿå°±æ˜¯ `STT`ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0be7d11fe6d64ac6a4cf890ffd480f1c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å®ç°å¦‚ä¸‹è¿”å›çš„ `text` å°±æ˜¯è¯†åˆ«çš„è¯­éŸ³å†…å®¹

```js
const {
  data: { text: prompt },
} = await openai.createTranscription(
  fs.createReadStream(fileName),
  "whisper-1"
);
```

## å®ç°æ–‡å­—è½¬è¯­éŸ³ï¼ˆTTSï¼‰

`OpenAI` ç›®å‰åªæä¾›äº† `STT`ï¼Œå¦‚æœéœ€è¦è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªéŸ³é¢‘çš„è¯ã€‚å°±éœ€è¦ç”¨åˆ°å›½å†…çš„ ç§‘å¤§è®¯é£ æ¯å¤©æœ‰ `5.05w` æ¬¡å…è´¹çš„ [TTS](https://console.xfyun.cn/services/tts)ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34b1ade9fa684ea2b0c08313334821cb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

å¦‚æœä½ æœ‰å›½å¤–ä¿¡ç”¨å¡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¾®è½¯æ¨å‡º `Azure`ï¼Œå¾ˆå¤šç”µæŠ¥æœºå™¨äººå°±æ˜¯ç”¨çš„å®ƒæ¥å¼€å‘çš„ï¼Œå…è´¹ä½¿ç”¨ 12 ä¸ªæœˆã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8af8d93e437544fd81ec914785d70ddb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

æ‰€ä»¥åœ¨è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ç§‘å¤§è®¯é£çš„ `TTS`

### æ–‡å­—ç”ŸæˆéŸ³é¢‘æ–‡ä»¶

éŸ³é¢‘æ²¡æœ‰ç›´æ¥è¿”å›æµï¼Œè€Œæ˜¯ç›´æ¥ç”Ÿæˆä¸€ä¸ªéŸ³é¢‘è¿”å›æ–‡ä»¶è·¯å¾„ç»™å‰ç«¯æ’­æ”¾ã€‚

å›å¤éŸ³é¢‘å­˜æ”¾åœ¨ chat-audio/client/audio ä¸­

å…ˆåœ¨ [è®¯é£ TTS](https://console.xfyun.cn/services/tts) ä¸­è·å–éœ€è¦çš„ keys

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c8786cf60ff14ddeb8448018e89bf791~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

```js
const tts = promisify(require("./utils/tts"));
// ç¯å¢ƒå˜é‡
require("dotenv").config();
// ç”ŸæˆéŸ³é¢‘
const generateAudio = (text) => {
  return new Promise((resolve, reject) => {
    const auth = {
      app_id: process.env.TTS_APP_ID,
      app_skey: process.env.TTS_API_SECRET,
      app_akey: process.env.TTS_API_KEY,
    };
    // è®¯é£ api å‚æ•°é…ç½®
    const business = {
      aue: "lame",
      sfl: 1,
      speed: 50,
      pitch: 50,
      volume: 100,
      bgs: 0,
    };
    const id = new Date().getTime();
    // å­˜å‚¨æ–‡ä»¶çš„è·¯å¾„
    const file = path.resolve(__dirname, `client/audio/${id}.m4a`);
    try {
      // æ‰§è¡Œè¯·æ±‚
      tts(auth, business, text, file).then((res) => {
        // è¿”å›é™æ€æ–‡ä»¶åœ°å€
        resolve(`audio/${id}.m4a`);
      });
    } catch (e) {
      reject(e);
    }
  });
};
```

å°è£…å¥½çš„è®¯é£çš„è¯­éŸ³åŒ… `TTS`ï¼Œæ”¾åœ¨ [ChatAudio ä»“åº“](https://github.com/CrazyMrYan/chat-audio) é‡Œé¢ã€‚è¿™é‡Œå°±ä¸å±•ç¤ºå‡ºæ¥äº†

## è°ƒç”¨ STT & TTS

### éŸ³é¢‘å¯¹è¯æ¥å£

é€šè¿‡ api/audioï¼Œè®©å®¢æˆ·ç«¯è°ƒç”¨æ­¤æ–¹æ³•

```js
app.use(fileUpload());
app.post("api/audio", async (req, res) => {
  // æ²¡æœ‰ä¸Šä¼ éŸ³é¢‘æŠ›å‡ºå¼‚å¸¸
  if (!req.files)
    return res.status(400).send({ message: "ç¼ºå°‘å‚æ•°", error: true });

  const file = req.files.file;
  // å­˜æ”¾ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
  const fileName = "audio.m4a";

  file.mv(fileName, async (err) => {
    if (err) {
      return res.status(500).send(err);
    }
    // ä½¿ç”¨ChatGPT çš„ STT æœºå™¨äººï¼ˆWhisperï¼‰
    const {
      data: { text: prompt },
    } = await openai.createTranscription(
      fs.createReadStream(fileName),
      "whisper-1"
    );
    console.log("è§£æçš„éŸ³é¢‘å†…å®¹æ˜¯>>>", prompt);

    // åˆ¤æ–­ç”¨æˆ·ä¸Šä¼ éŸ³é¢‘æ˜¯å¦å­˜åœ¨å†…å®¹
    if (!prompt.trim().length)
      return res.send({ message: "æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹", error: true });

    // å°†è½¬ç”¨æˆ·æé—®çš„æ–‡æœ¬å†…å®¹ï¼Œå»è°ƒç”¨ ChatGPT çš„å›å¤
    const chatReply = await handleIssueReply(prompt);

    // å°† ChatGPT çš„å›å¤é€šè¿‡ TTS è½¬åŒ–ä¸ºè¯­éŸ³
    const content = await generateAudio(chatReply);
    console.log("ç”Ÿæˆçš„éŸ³é¢‘æ˜¯>>>", content);

    res.send([
      {
        type: "system",
        content,
        chatReply,
        infoType: "audio",
        playStatus: false,
      },
    ]);
  });
});
```

### ChatGPT å›å¤é—®é¢˜èƒ½åŠ›

ä¸ç®¡æ˜¯ `TTS`ã€`STT`è¿˜æ˜¯`TTT`ï¼Œæœ€æ ¸å¿ƒå¯¹è¯åŠŸèƒ½è¿˜æ˜¯é€šè¿‡ `ChatGPT`å®ç°çš„ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32724800ef7a4874a2bae5db8cfe587e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)

ChatGPT é…ç½®å°±ä¸ç»†è¯´äº†ï¼Œé…ç½®ä¸€ä¸ª `KEY` ç„¶åå°è£…ä¸€ä¸ªå›å¤é—®é¢˜çš„æ–¹æ³•

[è·å– ChatGPT KEY](https://platform.openai.com/account/api-keys)

```js
const { Configuration, OpenAIApi } = require("openai");
// openai é…ç½®
const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
});
// åˆ›å»º openai å®ä¾‹
const openai = new OpenAIApi(configuration);

const handleIssueReply = async (prompt) => {
  const {
    data: { choices },
  } = await openai.createCompletion({
    model: "text-davinci-003",
    prompt,
    temperature: 0.5,
    max_tokens: 1000,
    top_p: 1.0,
    frequency_penalty: 0.0,
    presence_penalty: 0.0,
  });
  const chat = choices[0].text?.trim();
  console.log("ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹æ˜¯>>>", chat);
  return chat;
};
```

å®ç°æ•ˆæœå¦‚ä¸‹ï¼Œæ²¡æœ‰å½•å±å¯ä»¥è‡ªè¡Œæ„Ÿå—ä¸‹ã€‚

| ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c633e5578b094ff39eef27830a9b8a71~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp) | ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f37bb94b1b4743bcbaee923344486c3a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp) |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------ |

## è¡¥å……åŠŸèƒ½ Text To Text

å‰é¢åšçš„è¯­éŸ³å¯¹è¯ï¼Œåªæ˜¯ä¸ºäº†è®©ä½ ä¸å†å­¤å•å¯‚å¯ï¼Œä½†æ˜¯åœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­åŸºæœ¬ä¸Šä¸ä¼šä½¿ç”¨åˆ°è¯­éŸ³å¯¹è¯ï¼Œæ‰€ä»¥å•ç‹¬åšäº†ä¸ªå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æ–‡å­—èŠå¤©åŠŸèƒ½ã€‚

æ‰€ä»¥æ–°å¼€äº†ä¸€ä¸ªæ¥å£ç›´æ¥è°ƒç”¨ ChatGPT çš„å›å¤ã€‚

```js
app.get("/api/issue", async (req, res) => {
  // ä» query ä¸­å–å‡ºç”¨æˆ·æå‡ºçš„é—®é¢˜
  const { issue } = req.query;
  if (!issue.trim())
    return res.status(400).send({ message: "ç¼ºå°‘å‚æ•°", error: true });
  const chatReply = await handleIssueReply(issue);
  return res.send([{ type: "system", content: chatReply }]);
});
```

## å‰ç«¯å®ç°

å‰ç«¯æ²¡ä»€ä¹ˆå¤ªå¤šéœ€è¦æ³¨æ„çš„ï¼Œåˆ—ä¸€ä¸‹ä¾èµ–å§ï¼Œå‡é‡‡ç”¨çš„ `CDN`ã€‚

- Vue
- Elment UI

ä»£ç åœ¨ chat-audio/client/index.html è¿™é‡Œ

## ä½¿ç”¨ ChatAudio

### å…‹éš†

```bash
git clone git@github.com:CrazyMrYan/chat-audio.git
```

### é…ç½® Key

åœ¨ ENV æ–‡ä»¶ä¸­é…ç½® `ç§‘å¤§è®¯é£` å’Œ `OpenAI` çš„ `key`

### å®‰è£…å¯åŠ¨

```sql
yarn install

yarn start
```

### ä½¿ç”¨

æµè§ˆå™¨æ‰“å¼€ localhost:3000

å°±å¯ä»¥çœ‹åˆ°èŠå¤©ç•Œé¢äº†

> tips:

- å¼€ä¸‹ ke xue shang wang
- æœ€å¥½æ˜¯ ğŸ‡ºğŸ‡¸ èŠ‚ç‚¹

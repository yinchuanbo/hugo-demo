---
title: "React + Drag API å®ç°æ‹–æ‹½"
date: 2023-02-12T22:16:22+08:00
---

é¼ æ ‡æ‹–æ‹½æ˜¯ä¸€ä¸ªå¸¸è§çš„äº¤äº’åœºæ™¯ï¼Œåœ¨è¿™ä¸ªç†Ÿæ‚‰çš„è¿‡ç¨‹å°†ä¼šå‘ç”Ÿå“ªäº›äº‹ä»¶ï¼Ÿ

## è®¤è¯†æ‹–æ‹½

![Untitled-2022-06-04-1227.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/244fd0f37c58474a8011527ba9b41969~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

æ‹–æ‹½äº‹ä»¶æŒ‡ç”¨æˆ·é€šè¿‡é¼ æ ‡ï¼ˆæˆ–å…¶ä»–æŒ‡é’ˆè®¾å¤‡ï¼‰å°†å…ƒç´ ç§»åˆ°ä¸€ä¸ªæ–°çš„ä½ç½®ä¸Šã€‚æ‹–æ‹½è¿‡ç¨‹æ¶‰åŠä¸¤ä¸ªå¯¹è±¡ï¼šè¢«æ‹–æ‹½å…ƒç´ ï¼ˆä¸Šå›¾ä¸­ A ï¼‰å’Œå¯é‡Šæ”¾ç›®æ ‡ï¼ˆä¸Šå›¾ä¸­ B ï¼‰

### è¢«æ‹–æ‹½å…ƒç´ 

é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾ç‰‡ã€é“¾æ¥å’Œæ–‡æœ¬æ˜¯å¯æ‹–åŠ¨çš„ã€‚HTML5 åœ¨æ‰€æœ‰ HTML å…ƒç´ ä¸Šè§„å®šäº†ä¸€ä¸ª `draggable` å±æ€§ï¼Œ è¡¨ç¤ºå…ƒç´ æ˜¯å¦å¯ä»¥æ‹–åŠ¨ã€‚å›¾ç‰‡å’Œé“¾æ¥çš„ draggable å±æ€§è‡ªåŠ¨è¢«è®¾ç½®ä¸º trueï¼Œè€Œå…¶ä»–æ‰€æœ‰å…ƒç´ æ­¤å±æ€§çš„é»˜è®¤å€¼ä¸º falseã€‚

æŸä¸ªå…ƒç´ è¢«æ‹–åŠ¨æ—¶ï¼Œä¼šä¾æ¬¡è§¦å‘ä»¥ä¸‹äº‹ä»¶:

- `ondragstart`ï¼šæ‹–åŠ¨å¼€å§‹ï¼Œå½“é¼ æ ‡æŒ‰ä¸‹å¹¶ä¸”å¼€å§‹ç§»åŠ¨é¼ æ ‡æ—¶ï¼Œè§¦å‘æ­¤äº‹ä»¶ï¼›æ•´ä¸ªå‘¨æœŸåªè§¦å‘ä¸€æ¬¡ï¼›
- `ondrag`ï¼šåªè¦å…ƒç´ ä»è¢«æ‹–æ‹½ï¼Œå°±ä¼šæŒç»­è§¦å‘æ­¤äº‹ä»¶ï¼›
- `ondragend`ï¼šæ‹–æ‹½ç»“æŸï¼Œå½“é¼ æ ‡æ¾å¼€åï¼Œä¼šè§¦å‘æ­¤äº‹ä»¶ï¼›æ•´ä¸ªå‘¨æœŸåªè§¦å‘ä¸€æ¬¡ã€‚

### å¯é‡Šæ”¾ç›®æ ‡

å½“æŠŠæ‹–æ‹½å…ƒç´ ç§»åŠ¨åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„æ”¾ç½®ç›®æ ‡æ—¶ï¼Œç›®æ ‡å¯¹è±¡ä¼šè§¦å‘ä»¥ä¸‹äº‹ä»¶ï¼š

- `ondragenter`ï¼šåªè¦ä¸€æŠŠæ‹–æ‹½å…ƒç´ ç§»åŠ¨åˆ°ç›®æ ‡æ—¶ï¼Œå°±ä¼šè§¦å‘æ­¤äº‹ä»¶ï¼›
- `ondragover`ï¼šæ‹–æ‹½å…ƒç´ åœ¨ç›®æ ‡ä¸­æ‹–åŠ¨æ—¶ï¼Œä¼šæŒç»­è§¦å‘æ­¤äº‹ä»¶ï¼›
- `ondragleave` æˆ– `ondrop`ï¼šæ‹–æ‹½å…ƒç´ ç¦»å¼€ç›®æ ‡æ—¶ï¼ˆæ²¡æœ‰åœ¨ç›®æ ‡ä¸Šæ”¾ä¸‹ï¼‰ï¼Œä¼šè§¦å‘`ondragleave`ï¼›å½“æ‹–æ‹½å…ƒç´ åœ¨ç›®æ ‡æ”¾ä¸‹ï¼ˆæ¾å¼€é¼ æ ‡ï¼‰ï¼Œåˆ™è§¦å‘`ondrop`äº‹ä»¶ã€‚

> ğŸÂ  ç›®æ ‡å…ƒç´ é»˜è®¤æ˜¯ä¸èƒ½å¤Ÿè¢«æ‹–æ”¾çš„ï¼Œå³ä¸ä¼šè§¦å‘ Â `ondrop` äº‹ä»¶ï¼Œå¯ä»¥é€šè¿‡åœ¨ç›®æ ‡å…ƒç´ çš„ Â `ondragover`Â  äº‹ä»¶ä¸­å–æ¶ˆé»˜è®¤äº‹ä»¶æ¥è§£å†³æ­¤é—®é¢˜ã€‚

### ç”Ÿå‘½å‘¨æœŸ

![adsf3456345.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de34a21bb9c24e21a6e179e85ded1039~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

### æ‹–æ‹½æ“ä½œä¸­çš„æ•°æ®ä¼ è¾“

é™¤éæ•°æ®å—å½±å“ï¼Œå¦åˆ™ç®€å•çš„æ‹–æ”¾å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ã€‚ä¸ºå®ç°æ‹–åŠ¨æ“ä½œä¸­çš„æ•°æ®ä¼ è¾“ï¼Œ`event` å¯¹è±¡ä¸Šæš´éœ²äº† `dataTransfer` å¯¹è±¡ï¼Œç”¨äºä»è¢«æ‹–åŠ¨å…ƒç´ å‘æ”¾ç½®ç›®æ ‡ä¼ é€’å­—ç¬¦ä¸²æ•°æ®ã€‚æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥é€šçŸ¥ç”»å¸ƒï¼Œå½“å‰éœ€è¦æ¸²æŸ“çš„ç»„ä»¶æ˜¯ä»€ä¹ˆã€‚

dataTransfer å¯¹è±¡ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šgetData() å’Œ setData()ï¼Œåˆ†åˆ«ç”¨æ¥è·å–å’Œå­˜å‚¨å€¼ã€‚setData()çš„ç¬¬ä¸€ä¸ªå‚æ•°ä»¥åŠ getData()çš„å”¯ä¸€å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè¦è®¾ç½®çš„æ•°æ®ç±»å‹ï¼š"text"æˆ–"URL"

> ğŸÂ  è™½ç„¶è¿™ä¸¤ç§æ•°æ®ç±»å‹æ˜¯ IE æœ€åˆå¼•å…¥çš„ï¼Œä½† HTML5 å·²ç»å°†å…¶æ‰©å±•ä¸ºå…è®¸ä»»ä½• MIME ç±»å‹ã€‚ä¸ºå‘å å…¼å®¹ï¼ŒHTML5 è¿˜ä¼šç»§ç»­æ”¯æŒ"text"å’Œ"URL"ï¼Œä½†å®ƒä»¬ä¼šåˆ†åˆ«è¢«æ˜ å°„åˆ°"text/plain"å’Œ"text/uri-listâ€

éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå­˜å‚¨åœ¨ `dataTransfer` å¯¹è±¡ä¸­çš„æ•°æ®åªèƒ½åœ¨æ”¾ç½®äº‹ä»¶ä¸­è¯»å–ã€‚å¦‚æœæ²¡æœ‰åœ¨ `ondrop` äº‹ä»¶ä¸­å–å¾—è¿™äº›æ•°æ®ï¼Œ`dataTransfer` å¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œæ•°æ®ä¹Ÿä¼šä¸¢å¤±ã€‚

## ä»£ç å®ç°

æˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ React æ¥å®ç°ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°è·¨ç»„ä»¶é€šä¿¡ï¼Œæˆ‘ä½¿ç”¨äº† dva æ¥ç®¡ç†æ•°æ®æµã€‚

### å¦‚ä½•æ ‡è®°å½“å‰æ‹–æ‹½çš„å…ƒç´ ï¼Ÿ

HTML5 æ”¯æŒçš„ `data-x` å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†å½“å‰ç»„ä»¶çš„ç±»å‹ _Rectangle_ èµ‹å€¼ç»™å®ƒï¼Œè¿™æ ·å¤„ç†å’Œç”»å¸ƒç»„ä»¶é€šä¿¡æ–¹ä¾¿ä¸€äº›

```jsx
const Block = (props) => {
  const handleDragStart = (e: React.DragEvent<HTMLDivElement>) => {
    // å‘æ‹–æ‹½æ•°æ®ä¸­æ·»åŠ é¡¹ç›®
    e.dataTransfer.setData("text", e.target.dataset.index);
  };

  return (
    <div onDragStart={handleDragStart}>
      <Button draggable data-index="Rectangle">
        äºŒç»´ç 
      </Button>
    </div>
  );
};
```

åœ¨ä¸Šæ–‡ä¸­è®²åˆ°ï¼ŒdataTransfer çš„æ•°æ®å¿…é¡»åœ¨ handleDrop æ–¹æ³•ä¸­è·å–ã€‚å®é™…çš„ç”¨æ¥ä¿å­˜ç”»å¸ƒä¸­çš„æ‰€æœ‰ç»„ä»¶çš„æ•°æ®ï¼š

```jsx
function DragEditor(props) {
  const { dvaStore, dispatch } = props;

  // é˜»æ­¢æµè§ˆå™¨é»˜è®¤äº‹ä»¶ï¼Œå¦åˆ™ ondrop ä¸ä¼šè§¦å‘
  const handleDragOver = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
  };

  const handleDrop = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    // è·å–æ‹–æ‹½å…ƒç´ çš„ç»„ä»¶ç±»å‹
    const type = e.dataTransfer.getData('text');

    // COMPONENT_LIST å®šä¹‰äº†ç»„ä»¶çš„æ•°æ®æ ¼å¼ï¼Œæ ¹æ® type åŒ¹é…
    const component = COMPONENT_LIST.filter(
      (i) => i.component === type,
    )[0];

    // å°†ç»„ä»¶æ•°æ®æ·»åŠ åˆ° storeï¼Œç”»å¸ƒå°†ä¼šæ ¹æ®æ•°æ®æ¸²æŸ“å‡ºç»„ä»¶
    if (component) {
      dispatch?.({
        type: 'store/addComponent',
        payload: component,
      });
    }
  };

  return (...);
}
```

### åœ¨ç”»å¸ƒä¸­æ‹–åŠ¨

æ‹–åŠ¨ä¸»è¦ä¾èµ–ç»„ä»¶çš„åˆå§‹ä½ç½®ï¼Œé¼ æ ‡å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€‚æ ¹æ®åä¸¤ç»„å¾—åˆ°é¼ æ ‡ç§»åŠ¨çš„è·ç¦»ï¼Œå’Œåˆå§‹ä½ç½®ç›¸åŠ åï¼Œå¾—åˆ°æœ€ç»ˆä½ç½®ã€‚

```jsx
function DragEditor(props: IEditorProps) {
  const { dvaStore, dispatch } = props;

  const [startAxis, setStartAxis] = React.useState({ x: 0, y: 0 }); // é¼ æ ‡å¼€å§‹æ‹–åŠ¨æ—¶çš„ä½ç½®

  const handleDragStart = (e: React.DragEvent<HTMLDivElement>) => {
    setStartAxis({ x: e.clientX, y: e.clientY });
  };

  const handleDragEnd = (e: React.DragEvent<HTMLDivElement>, data: IComponentSchema) => {
    // é¼ æ ‡ç§»åŠ¨çš„è·ç¦»
    const displacementX = e.clientX - startAxis.x;
    const displacementY = e.clientY - startAxis.y;

    // è®¡ç®—ç»„ä»¶çš„ç»ˆç‚¹ä½ç½®ï¼šåˆå§‹ä½ç½® + é¼ æ ‡ç§»åŠ¨çš„è·ç¦»
    const endX = Number(data.style.left) + displacementX;
    const endY = Number(data.style.top) + displacementY;

    // é™åˆ¶åæ ‡çš„æœ€å°å€¼ä¸º 0
    const top = Math.max(endY, 0);
    const left = Math.max(endX, 0);

    // æ›´æ–°å½“å‰ç»„ä»¶æ ·å¼
    dispatch?.({
      type: 'store/setShapeStyle',
      payload: { top, left },
    });
  };

  return (
      {dvaStore.componentsData.map((i) => {
        return (
          <RenderComponent
            type={i.component}
            componentData={i}
            key={i.generateId}
            onDragStart={handleDragStart}
            onDragEnd={(e) => handleDragEnd(e, i)}
          />
        );
      })}
  );
}
```

## æ•°æ®ç»“æ„

æœ€åï¼Œå°±æ˜¯ç»„ä»¶å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ï¼ŒRenderComponent æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„ type å±æ€§æ¸²æŸ“å¯¹åº”çš„ç»„ä»¶ã€‚ç»„ä»¶çš„æ•°æ®ç»“æ„è®¾è®¡å¦‚ä¸‹ï¼š

```jsx
export const COMPONENT_LIST = [
  {
    component: "Rectangle", // ç»„ä»¶åç§°
    label: "çŸ©å½¢", // å·¦ä¾§ Blocks ç»„ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„åå­—
    propValue: "", // ç»„ä»¶æ‰€ä½¿ç”¨çš„å€¼
    icon: "BorderOuterOutlined", // å·¦ä¾§ç»„ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºçš„ icon å›¾æ ‡
    animations: [], // åŠ¨ç”»åˆ—è¡¨
    events: {}, // äº‹ä»¶åˆ—è¡¨
    style: {
      // ç»„ä»¶æ ·å¼
      width: 100,
      height: 100,
      top: 0,
      left: 0,
    },
  },
  {
    component: "Text",
    label: "æ–‡å­—",
    propValue: "æ–‡å­—",
    icon: "",
    animations: [],
    events: {},
    style: {
      width: 200,
      height: 33,
      fontSize: 14,
      fontWeight: 500,
      lineHeight: "",
      letterSpacing: 0,
      textAlign: "",
      color: "",
    },
  },
];
```

## æ€»ç»“

æ‹–æ‹½æ˜¯éå¸¸æœ‰è¶£çš„ä¸€ç§äº¤äº’ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ä»£ç åœºæ™¯ä¸‹éå¸¸é‡è¦ã€‚ä½¿ç”¨åŸç”Ÿ API èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´åŠ äº†è§£åº•å±‚çš„ä¸€äº›ç»†èŠ‚ï¼ŒReact ç¤¾åŒºä¹Ÿæœ‰ä¸€äº›ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå¦‚ï¼šreact-dragable, react-beautiful-dndï¼Œå¤§å®¶æœ‰å…´è¶£ä¸å¦¨å†å¤šäº†è§£ä¸‹ã€‚

## Links

- [HTML æ‹–æ”¾ API](https://www.notion.so/React-Drag-API-a8fef320c0fc43b1bc3da1a83311f1f6?pvs=4#ff31039d0c1542dd9a5270a936d15d6c)

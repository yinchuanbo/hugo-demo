---
title: "å›¾ç‰‡å‹ç¼©"
date: 2022-10-11T21:28:35+08:00
---

![å›¾ç‰‡ä¸å‹ç¼©ï¼Œå‰ç«¯è¦èƒŒé”… ğŸ³](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32618ebc15ac44439634301618e2a860~tplv-k3u1fbpfcp-zoom-crop-mark:3024:3024:3024:1702.awebp?)


> å¤§å®¶å¥½ï¼Œå¥½ä¹…æ²¡è§ï¼Œæœ€è¿‘æœ‰ç‚¹æ‡’ï¼Œå¾ˆä¹…æ²¡æ›´æ–°å•¦ã€‚è¿™æ¬¡è¦èŠçš„ä¸»é¢˜æ˜¯ã€Œå›¾ç‰‡å‹ç¼©ã€ã€‚åœ¨ä¸€èˆ¬é¡µé¢é‡Œé¢ï¼Œä½¿ç”¨æœ€å¤šçš„ã€Œé™æ€ç´ æã€éå›¾ç‰‡è«å±äº†ï¼Œè¿™æ¬¡è½®åˆ°å¯¹å®ƒåŠ¨æ‰‹ ğŸ‘Š ï¼

## èƒŒæ™¯

ğŸ¨(ç¾æœ¯): è¿™æ˜¯è¿™æ¬¡éœ€æ±‚çš„åˆ‡å›¾ ğŸ“ ï¼Œä½ çœ‹çœ‹æœ‰æ²¡é—®é¢˜ï¼Ÿ

ğŸ§‘â€ğŸ’»(å‰ç«¯): å¥½çš„ã€‚

é¡µé¢ä¸Šçº¿ ...

ğŸ§‘â€ğŸ’¼(äº§å“): è¿™å›¾ç‰‡æ€ä¹ˆåŠå¤©åŠ è½½ä¸å‡ºæ¥ ğŸ’¢ ï¼Ÿ

ğŸ§‘â€ğŸ’»(å‰ç«¯): æˆ‘çœ‹çœ‹ ğŸ¤” (å‘å¾®)ã€‚

... ğŸ“(size: 15MB)

ğŸ§‘â€ğŸ’»(å‰ç«¯): ğŸ˜…ã€‚

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä» `PS` ã€`è“æ¹–`æˆ–`æ‘¹å®¢`ç­‰å·¥å…·å¯¼å‡ºæ¥çš„å›¾ç‰‡ï¼Œæˆ–è€…æ˜¯ç¾æœ¯ç›´æ¥ç»™åˆ°åˆ‡å›¾ï¼Œéƒ½æ˜¯æœªç»è¿‡å‹ç¼©çš„ï¼Œä½“ç§¯éƒ½æ¯”è¾ƒå¤§ã€‚è¿™é‡Œï¼Œå°±æœ‰äº†å¯ä¼˜åŒ–çš„ç©ºé—´ã€‚

## TinyPng

> `TinyPNG`ä½¿ç”¨æ™ºèƒ½çš„ã€Œæœ‰æŸå‹ç¼©æŠ€æœ¯ã€æ¥å‡å°‘`WEBP`ã€`JPEG`å’Œ`PNG`æ–‡ä»¶çš„æ–‡ä»¶å¤§å°ã€‚é€šè¿‡é€‰æ‹©æ€§åœ°å‡å°‘å›¾åƒä¸­çš„ã€Œé¢œè‰²æ•°é‡ã€ï¼Œä½¿ç”¨æ›´å°‘çš„å­—èŠ‚æ¥å­˜å‚¨æ•°æ®ã€‚è¿™ç§æ•ˆæœå‡ ä¹æ˜¯çœ‹ä¸è§çš„ï¼Œä½†åœ¨æ–‡ä»¶å¤§å°ä¸Šæœ‰éå¸¸å¤§çš„å·®åˆ«ã€‚

ä½¿ç”¨è¿‡[TinyPng](https://tinypng.com/)çš„éƒ½çŸ¥é“ï¼Œå®ƒçš„å‹ç¼©æ•ˆæœéå¸¸å¥½ï¼Œä½“ç§¯å¤§å¹…åº¦é™ä½ä¸”æ˜¾ç¤ºæ•ˆæœå‡ ä¹æ²¡æœ‰åŒºåˆ«( ğŸ‘€ çœ‹ä¸å‡ºåŒºåˆ«ï¼‰ã€‚å› æ­¤ï¼Œé€‰æ‹©å…¶ä½œä¸ºå‹ç¼©å·¥å…·ï¼Œæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

`TinyPng`æä¾›ä¸¤ç§å‹ç¼©æ–¹æ³•ï¼š

1. é€šè¿‡åœ¨å®˜ç½‘ä¸Šè¿›è¡Œæ‰‹åŠ¨å‹ç¼©ï¼›
2. é€šè¿‡å®˜æ–¹æä¾›çš„`tinify`è¿›è¡Œå‹ç¼©ï¼›

èº«ä¸ºä¸€ä¸ªç¨‹åºå‘˜ ğŸ§‘â€ğŸ’» ï¼Œæ˜¯ä¸èƒ½æ¥å—æ‰‹åŠ¨ä¸€å¼ å¼ ä¸Šä¼ å‹ç¼©è¿™ç§æ–¹æ³•çš„ã€‚å› æ­¤ï¼Œé€‰æ‹©ç¬¬äºŒç§æ–¹æ³•ï¼Œé€šè¿‡å°è£…ä¸€ä¸ªå·¥å…·ï¼Œå¯¹é¡¹ç›®å†…çš„å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼Œå½»åº•é‡Šæ”¾åŒæ‰‹ ğŸ¤² ã€‚

## å·¥å…·ç±»å‹

ç¬¬ä¸€æ­¥ï¼Œæ€è€ƒè¿™ä¸ªå·¥å…·çš„ã€Œç›®çš„ã€æ˜¯ä»€ä¹ˆï¼Ÿæ²¡é”™ï¼Œã€Œå‹ç¼©å›¾ç‰‡ã€ã€‚

ç¬¬äºŒæ­¥ï¼Œæ€è€ƒåœ¨å“ªä¸ªã€Œç¯èŠ‚ã€è¿›è¡Œå‹ç¼©ï¼Ÿæ²¡é”™ï¼Œã€Œå‘å¸ƒå‰ã€ã€‚

è¿™æ ·çœ‹æ¥ï¼Œå¼€å‘ä¸€ä¸ª`webpack plugin`æ˜¯ä¸€ä¸ªä¸é”™é€‰æ‹©ï¼Œåœ¨æ‰“åŒ…ã€Œç”Ÿäº§ç¯å¢ƒã€ä»£ç çš„æ—¶å€™ï¼Œå¯ç”¨è¯¥`plugin`å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼Œå®Œç¾ ğŸ¥³ ï¼

ä½†æ˜¯ï¼Œè¿™æ ·ä¼šé¢ä¸´ä¸¤ä¸ªé—®é¢˜ ğŸ¤” ï¼š

1. é¡µé¢è¿­ä»£ï¼Œæ–°å¢äº†å‡ å¼ å›¾ç‰‡ï¼Œé‡æ–°æ‰“åŒ…ä¸Šçº¿æ—¶ï¼Œä¼šå¯¼è‡´æ—§å›¾ç‰‡è¢«å¤šæ¬¡å‹ç¼©ï¼›
2. æ— æ³•é€‰æ‹©å“ªäº›å›¾ç‰‡è¦è¢«å‹ç¼©ï¼Œå“ªäº›å›¾ç‰‡ä¸è¢«å‹ç¼©ï¼›

è™½ç„¶å¯ä»¥é€šè¿‡ã€Œé…ç½®ã€çš„æ–¹å¼è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä½†æ¯æ¬¡æ‰“åŒ…éƒ½è¦ç‰¹æ®Šé…ç½®ï¼Œç•¥æ˜¾éº»çƒ¦ï¼Œè¿™æ ·çœ‹æ¥`plugin`å¥½åƒä¸æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚

ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ã€Œå‘½ä»¤è¡Œå·¥å…·ã€å°±èƒ½å®Œç¾è§£å†³ã€‚åœ¨æ‰“åŒ…ã€Œç”Ÿäº§ç¯å¢ƒã€ä»£ç ä¹‹å‰ï¼Œæ‰§è¡Œã€Œå‹ç¼©å‘½ä»¤ã€ï¼Œé€šè¿‡å‘½ä»¤è¡Œäº¤äº’ï¼Œé€‰æ‹©éœ€è¦å‹ç¼©çš„å›¾ç‰‡ã€‚

## æ•ˆæœæ¼”ç¤º

è¯ä¸å¤šè¯´ï¼Œå…ˆä¸Šæ‰è‰º ğŸ’ƒ ï¼

1. å®‰è£…

```shell
$ npm i yx-tiny -D
```

2. ä½¿ç”¨

```shell
$ npx tiny
```

3. æ ¹æ®å‘½ä»¤è¡Œæç¤ºè¾“å…¥

![10æœˆ10æ—¥.2022-10-10 5_57_17 PM.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/edc39ef452134045a9cb68242705b415~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

æµç¨‹ï¼šè¾“å…¥ã€Œæ–‡ä»¶å¤¹åç§°-`tinyImg`ã€ï¼Œæ¥ç€å·¥å…·ä¼šæ‰¾åˆ°å½“å‰é¡¹ç›®ä¸‹æ‰€æœ‰çš„`tinyImg`ï¼Œæ¥ç€é€‰æ‹©ä¸€æˆ–å¤šä¸ª`tinyImg`ï¼Œç´§æ¥ç€ï¼Œå·¥å…·ä¼šæ‰¾å‡º`tinyImg`ä¸‹æ‰€æœ‰çš„`png`ã€`jpe?g`å’Œ`svga`ï¼Œæœ€åé€‰æ‹©å‹ç¼©æ¨¡å¼ã€Œå…¨é‡ã€æˆ–ã€Œè‡ªå®šä¹‰ã€ï¼Œé€‰æ‹©éœ€è¦å‹ç¼©çš„å›¾ç‰‡ã€‚

ä»æœ€åçš„è¾“å‡ºç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå‹ç¼©å‰çš„èµ„æºä½“ç§¯ä¸º`2.64MB`ï¼Œå‹ç¼©åä½“ç§¯ä¸º`1.02MB`ï¼Œè¶³è¶³å‹ç¼©äº†`1.62MB` ğŸ‘ ï¼

## å®ç°æ€è·¯

æ€»ä½“åˆ†ä¸ºäº”ä¸ªè¿‡ç¨‹ï¼š

1. æŸ¥æ‰¾ï¼šæ‰¾å‡ºæ‰€æœ‰çš„å›¾ç‰‡èµ„æºï¼›
2. åˆ†é…ï¼šå‡åˆ†ä»»åŠ¡åˆ°æ¯ä¸ªè¿›ç¨‹ï¼›
3. ä¸Šä¼ ï¼šæŠŠåŸå›¾ä¸Šä¼ åˆ°`TinyPng`ï¼›
4. ä¸‹è½½ï¼šä»`TinyPng`ä¸­ä¸‹è½½å‹ç¼©å¥½çš„å›¾ç‰‡ï¼›
5. å†™å…¥ï¼šç”¨ä¸‹è½½çš„å›¾ç‰‡è¦†ç›–æœ¬åœ°å›¾ç‰‡ï¼›

é¡¹ç›®åœ°å€ï¼š[yx-tiny](https://github.com/yxichan/lerna-npm/tree/master/packages/tiny)

### æŸ¥æ‰¾

æ‰¾å‡ºæ‰€æœ‰çš„å›¾ç‰‡èµ„æºã€‚

> packages/tiny/src/index.ts

```ts
/**
 * é€’å½’æ‰¾å‡ºæ‰€æœ‰å›¾ç‰‡
 * @param { string } path
 * @returns { Array<imageType> }
 */
interface IdeepFindImg {
  (path: string): Array<imageType>;
}
let deepFindImg: IdeepFindImg;
deepFindImg = (path: string) => {
  // è¯»å–æ–‡ä»¶å¤¹çš„å†…å®¹
  const content = fs.readdirSync(path);
  // ç”¨äºä¿å­˜å‘ç°çš„å›¾ç‰‡
  let images: Array<imageType> = [];
  // éå†è¯¥æ–‡ä»¶å¤¹å†…å®¹
  content.forEach((folder) => {
    const filePath = resolve(path, folder);
    // è·å–å½“å‰å†…å®¹çš„è¯­æ³•ä¿¡æ¯
    const info = fs.statSync(filePath);
    // å½“å‰å†…å®¹ä¸ºâ€œæ–‡ä»¶å¤¹â€
    if (info.isDirectory()) {
      // å¯¹è¯¥æ–‡ä»¶å¤¹è¿›è¡Œé€’å½’æ“ä½œ
      images = [...images, ...deepFindImg(filePath)];
    } else {
      const fileNameReg = /\.(jpe?g|png|svga)$/;
      const shouldFormat = fileNameReg.test(filePath);
      // åˆ¤æ–­å½“å‰å†…å®¹çš„è·¯å¾„æ˜¯å¦åŒ…å«å›¾ç‰‡æ ¼å¼
      if (shouldFormat) {
        // è¯»å–å›¾ç‰‡å†…å®¹ä¿å­˜åˆ°images
        const imgData = fs.readFileSync(filePath);
        images.push({
          path: filePath,
          file: imgData,
        });
      }
    }
  });
  return images;
};
```

é€šè¿‡å‘½ä»¤è¡Œäº¤äº’åï¼Œæ‹¿åˆ°ç›®æ ‡æ–‡ä»¶å¤¹çš„è·¯å¾„`path`ï¼Œç„¶åè·å–è¯¥`path`ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼Œæ¥ç€éå†æ‰€æœ‰å†…å®¹ã€‚é¦–å…ˆåˆ¤æ–­è¯¥å†…å®¹çš„æ–‡ä»¶ä¿¡æ¯ï¼šè‹¥ä¸ºâ€œæ–‡ä»¶å¤¹â€ï¼Œåˆ™æŠŠè¯¥æ–‡ä»¶å¤¹è·¯å¾„ä½œä¸º`path`ï¼Œé€’å½’è°ƒç”¨`deepFindImg`ï¼›è‹¥ä¸ä¸ºâ€œæ–‡ä»¶å¤¹â€ï¼Œåˆ¤æ–­è¯¥å†…å®¹ä¸ºå›¾ç‰‡ï¼Œåˆ™è¯»å–å›¾ç‰‡æ•°æ®ï¼Œ`push`åˆ°`images`ä¸­ã€‚æœ€åï¼Œè¿”å›æ‰€æœ‰æ‰¾åˆ°çš„å›¾ç‰‡ã€‚

### åˆ†é…

å‡åˆ†ä»»åŠ¡åˆ°æ¯ä¸ªè¿›ç¨‹ã€‚

> packages/tiny/src/index.ts

```ts
// ...
cluster.setupPrimary({
    exec: resolve(__dirname, 'features/process.js')
})

// è‹¥èµ„æºæ•°å°äºåˆ™åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œå¦åˆ™åˆ›å»ºå¤šä¸ªè¿›ç¨‹
const works: Array<{
    work: Worker;
    tasks: Array<imageType>
}> =[]
if (list.length <= cpuNums) {
    works.push({
        work: cluster.fork(),
        tasks: list
    })
} else {
    for (let i = 0; i < cpuNums; ++i) {
        const work = cluster.fork()
        works.push({
            work,
            tasks: []
        })
    }
}

// å¹³å‡åˆ†é…ä»»åŠ¡
let workNum = 0
list.forEach(task = >{
    if (works.length === 1) {
        return
    } else if (workNum >= works.length) {
        works[0].tasks.push(task)
        workNum = 1
    } else {
        works[workNum].tasks.push(task)
        workNum += 1
    }
})

// ç”¨äºè®°å½•è¿›ç¨‹å®Œæˆæ•°
let pageNum = works.length

// åˆå§‹åŒ–è¿›åº¦æ¡
// ...

works.forEach(({
    work,
    tasks
}) = >{
    // å‘é€ä»»åŠ¡åˆ°æ¯ä¸ªè¿›ç¨‹
    work.send(tasks)
    // æ¥æ”¶ä»»åŠ¡å®Œæˆ
    work.on('message', (details: Idetail[]) = >{
        // æ›´æ–°è¿›åº¦æ¡
        // ...
        pageNum--
        // æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
        if (pageNum === 0) {
            // å…³é—­è¿›ç¨‹
            cluster.disconnect()
        }
    })
})
```

ä½¿ç”¨`cluster`ï¼Œæ ¹æ®ã€Œcpu æ ¸å¿ƒæ•°ã€åˆ›å»ºç­‰é‡çš„è¿›ç¨‹ï¼Œ`works`ç”¨äºä¿å­˜å·²åˆ›å»ºçš„è¿›ç¨‹ï¼Œ`list`ä¸­ä¿å­˜çš„æ˜¯è¦å¤„ç†çš„å‹ç¼©ä»»åŠ¡ï¼Œé€šè¿‡éå†`list`ï¼ŒæŠŠä»»åŠ¡ä¾æ¬¡åˆ†ç»™æ¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ¥ç€éå†`works`ï¼Œé€šè¿‡`send`æ–¹æ³•å‘é€è¿›ç¨‹ä»»åŠ¡ã€‚é€šè¿‡ç›‘å¬`message`äº‹ä»¶ï¼Œåˆ©ç”¨`pageNum`è®°å½•è¿›ç¨‹ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼Œå½“æ‰€æœ‰è¿›ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œåˆ™å…³é—­è¿›ç¨‹ã€‚

### ä¸Šä¼ 

å®˜æ–¹æä¾›çš„`tinify`å·¥å…·æœ‰ã€Œ500 å¼ /æœˆã€çš„é™é¢ï¼Œè¶…è¿‡é™é¢åï¼Œéœ€è¦ä»˜è´¹ã€‚

![æˆªå±2022-10-10 ä¸‹åˆ6.33.48.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82e9baf8650c4f0eb47f68b08f913eaa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?)

ç”±äºå®¶å¢ƒè´«å¯’ï¼Œä¸”å‡ºäºå­¦ä¹ çš„ç›®çš„ï¼Œå°±æ²¡æœ‰ä½¿ç”¨`tinify`ï¼Œè€Œæ˜¯é€šè¿‡æ„é€ éšæœº`IP`æ¥ç›´æ¥è¯·æ±‚ã€Œå‹ç¼©æ¥å£ã€æ¥è¾¾åˆ°ã€Œç ´è§£é™é¢ã€çš„ç›®çš„ã€‚å¤§å®¶åœ¨çœŸæ­£ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦ä½¿ç”¨`tinyfy`æ¥å‹ç¼©ï¼Œä¸è¦åšè¿™ç§æŠ•æœºå–å·§çš„äº‹ã€‚

å¥½äº†ï¼Œå›åˆ°æ­£æ–‡ã€‚

æŠŠåŸå›¾ä¸Šä¼ åˆ°`TinyPng`ã€‚

> packages/tiny/src/features/index.ts

```ts
/**
 * ä¸Šä¼ å‡½æ•°
 * @param { Buffer } file æ–‡ä»¶bufferæ•°æ®
 * @returns { Promise<DataUploadType> }
 */
interface Iupload {
  (file: Buffer): Promise<DataUploadType>;
}
export let upload: Iupload;
upload = (file: Buffer) => {
  // ç”Ÿæˆéšæœºè¯·æ±‚å¤´
  const header = randomHeader();
  return new Promise((resolve, reject) => {
    const req = Https.request(header, (res) => {
      res.on("data", (data) => {
        try {
          const resp = JSON.parse(data.toString()) as DataUploadType;
          if (resp.error) {
            reject(resp);
          } else {
            resolve(resp);
          }
        } catch (err) {
          reject(err);
        }
      });
    });
    // ä¸Šä¼ å›¾ç‰‡buffer
    req.write(file);
    req.on("error", (err) => reject(err));
    req.end();
  });
};
```

ä½¿ç”¨`node`è‡ªå¸¦çš„`Https`æ¨¡å—ï¼Œæ„é€ è¯·æ±‚å¤´ï¼ŒæŠŠ`deepFindImg`ä¸­è¿”å›çš„å›¾ç‰‡è¿›è¡Œä¸Šä¼ ã€‚ä¸Šä¼ æˆåŠŸåï¼Œä¼šè¿”å›å·²ç»å‹ç¼©å¥½çš„å›¾ç‰‡çš„`url`é“¾æ¥ã€‚

### ä¸‹è½½

ä»`TinyPng`ä¸­ä¸‹è½½å‹ç¼©å¥½çš„å›¾ç‰‡ã€‚

> packages/tiny/src/features/index.ts

```ts
/**
 * ä¸‹è½½å‡½æ•°
 * @param { string } path
 * @returns { Promise<string> }
 */
interface Idownload {
  (path: string): Promise<string>;
}
export let download: Idownload;
download = (path: string) => {
  const header = new Url.URL(path);
  return new Promise((resolve, reject) => {
    const req = Https.request(header, (res) => {
      let content = "";
      res.setEncoding("binary");
      res.on("data", (data) => (content += data));
      res.on("end", () => resolve(content));
    });
    req.on("error", (err) => reject(err));
    req.end();
  });
};
```

ä½¿ç”¨`node`è‡ªå¸¦çš„`Https`æ¨¡å—æŠŠ`upload`ä¸­è¿”å›çš„å›¾ç‰‡é“¾æ¥è¿›è¡Œä¸‹è½½ã€‚ä¸‹è½½æˆåŠŸåï¼Œè¿”å›å›¾ç‰‡çš„`buffer`æ•°æ®ã€‚

### å†™å…¥

æŠŠä¸‹è½½å¥½çš„å›¾ç‰‡è¦†ç›–æœ¬åœ°å›¾ç‰‡ã€‚

> packages/tiny/src/features/process.ts

```ts
/**
 * æ¥æ”¶è¿›ç¨‹ä»»åŠ¡
 */
process.on("message", (tasks: imageType[]) => {
  (async () => {
    // ä¼˜åŒ– png/jpg
    const data = tasks
      .filter(({ path }: { path: string }) => /\.(jpe?g|png)$/.test(path))
      .map((ele) => {
        return compressImg({ ...ele, file: Buffer.from(ele.file) });
      });

    // ä¼˜åŒ– svga
    const svgaData = tasks
      .filter(({ path }: { path: string }) => /\.(svga)$/.test(path))
      .map((ele) => {
        return compressSvga(ele.path, Buffer.from(ele.file));
      });

    const details = await Promise.all([
      ...data.map((fn) => fn()),
      ...svgaData.map((fn) => fn()),
    ]);

    // å†™å…¥
    await Promise.all(
      details.map(
        ({ path, file }) =>
          new Promise((resolve, reject) => {
            fs.writeFile(path, file, (err) => {
              if (err) reject(err);
              resolve(true);
            });
          })
      )
    );

    // å‘é€ç»“æœ
    if (process.send) {
      process.send(details);
    }
  })();
});
```

`process.on`ç›‘å¬æ¯ä¸ªè¿›ç¨‹å‘é€çš„ä»»åŠ¡ï¼Œå½“æ¥æ”¶åˆ°ä»»åŠ¡ç±»å‹ä¸ºã€Œå›¾ç‰‡ã€ï¼Œä½¿ç”¨`compressImg`æ–¹æ³•æ¥å¤„ç†å›¾ç‰‡ã€‚å½“ä»»åŠ¡ç±»å‹ä¸ºã€Œsvgaã€ï¼Œä½¿ç”¨`compressSvga`æ–¹æ³•æ¥å¤„ç†`svga`ã€‚æœ€åæŠŠå¤„ç†å¥½çš„èµ„æºå†™å…¥åˆ°æœ¬åœ°è¦†ç›–æ—§èµ„æºã€‚

#### compressImg

> packages/tiny/src/features/process.ts

```ts
/**
 * å‹ç¼©å›¾ç‰‡
 * @param { imageType } å›¾ç‰‡èµ„æº
 * @returns { promise<Idetail> }
 */
interface IcompressImg {
  (payload: imageType): () => Promise<Idetail>;
}
let compressImg: IcompressImg;
compressImg = ({ path, file }: imageType) => {
  return async () => {
    const result = {
      input: 0,
      output: 0,
      ratio: 0,
      path,
      file,
      msg: "",
    };
    try {
      // ä¸Šä¼ 
      const dataUpload = await upload(file);

      // ä¸‹è½½
      const dataDownload = await download(dataUpload.output.url);

      result.input = dataUpload.input.size;
      result.output = dataUpload.output.size;
      result.ratio = 1 - dataUpload.output.ratio;
      result.file = Buffer.alloc(dataDownload.length, dataDownload, "binary");
    } catch (err) {
      result.msg = `[${chalk.blue(path)}] ${chalk.red(JSON.stringify(err))}`;
    }
    return result;
  };
};
```

`compressImg`è¿”å›ä¸€ä¸ª`async`å‡½æ•°ï¼Œè¯¥å‡½æ•°å…ˆè°ƒç”¨`upload`è¿›è¡Œå›¾ç‰‡ä¸Šä¼ ï¼Œæ¥ç€è°ƒç”¨`download`è¿›è¡Œä¸‹è½½ï¼Œæœ€ç»ˆè¿”å›è¯¥å›¾ç‰‡çš„`buffer`æ•°æ®ã€‚

#### compressSvga

> packages/tiny/src/features/process.ts

```ts
/**
 * å‹ç¼©svga
 * @param { string } path è·¯å¾„
 * @param { buffer } source svga buffer
 * @returns { promise<Idetail> }
 */
interface IcompressSvga {
  (path: string, source: Buffer): () => Promise<Idetail>;
}
let compressSvga: IcompressSvga;
compressSvga = (path, source) => {
  return async () => {
    const result = {
      input: 0,
      output: 0,
      ratio: 0,
      path,
      file: source,
      msg: "",
    };
    try {
      // è§£æsvga
      const data = ProtoMovieEntity.decode(
        pako.inflate(toArrayBuffer(source))
      ) as unknown as IsvgaData;
      const { images } = data;
      const list = Object.keys(images).map((path) => {
        return compressImg({ path, file: toBuffer(images[path]) });
      });

      // å¯¹svgaå›¾ç‰‡è¿›è¡Œå‹ç¼©
      const detail = await Promise.all(list.map((fn) => fn()));
      detail.forEach(({ path, file }) => {
        data.images[path] = file;
      });

      // å‹ç¼©buffer
      const file = pako.deflate(
        toArrayBuffer(ProtoMovieEntity.encode(data).finish() as Buffer)
      );
      result.input = source.length;
      result.output = file.length;
      result.ratio = 1 - file.length / source.length;
      result.file = file;
    } catch (err) {
      result.msg = `[${chalk.blue(path)}] ${chalk.red(JSON.stringify(err))}`;
    }
    return result;
  };
};
```

`compressSvga`çš„ã€Œè¾“å…¥ã€ã€ã€Œè¾“å‡ºã€å’Œ`compressImg`ä¿æŒä¸€è‡´ï¼Œç›®çš„æ˜¯ä¸ºäº†å¯ä»¥ä½¿ç”¨`promise.all`åŒæ—¶è°ƒç”¨ã€‚åœ¨`compressSvga`å†…éƒ¨ï¼Œå¯¹`svga`è¿›è¡Œè§£ææˆ`data`ï¼Œè·å–åˆ°`svga`çš„å›¾ç‰‡åˆ—è¡¨`images`ï¼Œæ¥ç€è°ƒç”¨`compressImg`å¯¹`images`è¿›è¡Œå‹ç¼©ï¼Œä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡è¦†ç›–`data.images`ï¼Œæœ€åå†æŠŠ`data`ç¼–ç åï¼Œå†™å…¥åˆ°æœ¬åœ°è¦†ç›–åŸæœ¬çš„`svga`ã€‚

## æœ€å

å†è¯´ä¸€éï¼Œå¤§å®¶çœŸæ­£ä½¿ç”¨çš„æ—¶å€™ï¼Œè¦ä½¿ç”¨å®˜æ–¹çš„`tinify`è¿›è¡Œå‹ç¼©ã€‚

---
title: "JS WeakMap应该什么时候使用"
date: 2023-04-18T10:41:45+08:00
---

在 JavaScript 编程中，有一些数据结构可以用于处理对象之间的关系，例如对象字面量、数组、Map 和 Set。但是，在某些情况下，使用 WeakMap 可以提供更好的解决方案，避免了一些常见的问题。

## 什么是 WeakMap？

WeakMap 是 JavaScript 的一个内置对象，用于保存键值对。与普通的 Map 不同的是，WeakMap 中的键只能是对象，并且作为键的对象必须是可垃圾回收的。这意味着，如果没有其他引用指向作为键的对象，那么它们就可以被垃圾回收器回收。

与普通的 Map 相比，WeakMap 不支持迭代，也无法获取其大小。此外，WeakMap 中的键是弱引用，如果垃圾回收器发现了一个键不再被使用，那么整个键值对将被自动移除。这种设计使得 WeakMap 非常适合存储“私有”数据，例如 DOM 元素或类实例的私有属性。

以下是一些基本操作 WeakMap 的示例代码：

```javascript
// 创建一个新的 WeakMap 对象
const myWeakMap = new WeakMap();

// 添加一个新的键值对
const obj1 = {};
myWeakMap.set(obj1, "value1");

// 获取一个键对应的值
myWeakMap.get(obj1); // "value1"

// 删除一个键值对
myWeakMap.delete(obj1);
```

## 为什么应该使用 WeakMap？

在某些情况下，使用 WeakMap 可以提供更好的解决方案，避免了一些常见的问题。

### 避免内存泄漏

内存泄漏是一个常见的问题，特别是在处理对象之间的关系时。例如，如果您想要在一个对象中保存另一个对象的引用，但又不想让后者变成一个不必要的长期依赖项，那么将对象保存到 WeakMap 中就是一个好的选择。

由于 WeakMap 的键是弱引用，如果没有其他东西指向键（也就是说，键没有其他被称为“强引用”的变量引用它），则可以通过垃圾回收器自动从 WeakMap 中删除条目。

### 隐藏私有数据

JavaScript 是一种动态语言，这意味着您可以在运行时更改对象的属性和方法。然而，在某些情况下，您可能需要限制对象的公共接口，并且仅让特定代码访问某些属性和方法。使用模块模式或闭包等技术可以实现这一点，但是这些技术通常难以保护私有数据免受攻击者的访问。

在这种情况下，将私有数据存储在 WeakMap 中可能是更好的选择。由于 WeakMap 的键必须是对象，这些键通常可以通过作用域链、闭包或其他技术隐藏起来，使它们对外部代码不可见。

### 避免污染全局空间

在 JavaScript 中，全局命名空间经常被滥用，很容易导致名称冲突和代码混乱。使用 WeakMap 可以避免这种问题，因为您可以将键保存在 WeakMap 中，而不是在全局命名空间中。

例如，如果您需要在多个函数之间共享一些状态，则可以创建一个 WeakMap 对象，并使用其键存储状态。由于键是弱引用，无需担心这些键被分配到全局命名空间中。

## 什么时候应该使用 WeakMap？

尽管 WeakMap 提供了一些显著的优点，但并不是所有场景都适合使用 WeakMap。以下是一些建议的使用场景：

- 需要将对象保存为键，并且希望在没有其他强引用时自动删除键值对。
- 希望隐藏对象的私有数据，并保护它们免受外部代码的干扰。
- 希望避免在全局命名空间中分配键。

需要注意的是，在某些情况下，使用 WeakMap 可能会使代码更加复杂。例如，如果您需要在多个函数之间共享状态，则必须确保它们都可以访问 WeakMap 对象。这可能需要传递 WeakMap 对象或在闭包中使用它。

此外，由于 WeakMap 不支持迭代和获取其大小，它通常不适用于要求遍历所有键值对或查询当前大小的场景。
